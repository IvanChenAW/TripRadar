<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>TripRadar Â· å»ºè­°æ—…éŠåˆ†æ•¸ + äº¤é€šèˆ‡ç½å®³é¢¨éšªï¼ˆv5.7ï¼‰</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Ccircle cx='8' cy='8' r='8' fill='%232563eb'/%3E%3C/svg%3E"/>
<style>
:root{
  --brand:#2563eb; --panel:#f8fafc; --ink:#0f172a; --muted:#64748b;
  --ok:#16a34a; --warn:#d97706; --danger:#dc2626;
  --ok-bg:#ecfdf5; --warn-bg:#fff7ed; --danger-bg:#fef2f2; --info-bg:#eef2ff;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:#f1f5f9;color:var(--ink);font:16px/1.5 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC",sans-serif}
.wrap{max-width:1200px;margin:auto;padding:18px}
.header{background:linear-gradient(180deg,#1d4ed8,#60a5fa);color:#fff;padding:22px 18px 30px}
.title{font-size:28px;font-weight:900}
.sub{opacity:.9;margin-top:6px}
.panel{background:#fff;border-radius:16px;box-shadow:0 10px 20px rgba(2,6,23,.06);padding:12px 12px;margin-top:-20px}
.row{display:flex;gap:10px;flex-wrap:wrap}
.badge{display:inline-flex;align-items:center;gap:8px;background:#eef2ff;border-radius:999px;padding:7px 12px;font-weight:800;color:#1e293b}
.btn{border:none;border-radius:12px;background:#e2e8f0;padding:10px 14px;font-weight:800;cursor:pointer}
.btn.brand{background:#1d4ed8;color:#fff}
.select{border-radius:12px;border:1px solid #e2e8f0;padding:10px 12px;font-weight:800}

.legend{display:flex;gap:14px;align-items:center;color:#334155;margin-top:6px}
.dot{width:12px;height:12px;border-radius:50%}
.dot.green{background:#22c55e}
.dot.blue{background:#3b82f6}
.dot.amber{background:#f59e0b}
.dot.red{background:#ef4444}

.grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:14px}
@media (max-width:980px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
@media (max-width:720px){.grid{grid-template-columns:1fr}}

.card{background:#fff;border-radius:14px;border:1px solid #e5e7eb;padding:14px;display:flex;flex-direction:column;gap:10px}
.card-hd{display:flex;justify-content:space-between;align-items:center}
.card-ttl{font-size:20px;font-weight:900}
.score-pill{background:#fb923c;color:#111827;border-radius:999px;font-weight:900;padding:8px 12px}
.metrics{display:flex;gap:10px;flex-wrap:wrap}
.tag{background:#f1f5f9;border-radius:999px;padding:8px 10px;font-weight:800;color:#1e293b}
.sugg{font-weight:800}
.acts{display:flex;gap:8px;flex-wrap:wrap}
.actBtn{border:none;border-radius:12px;background:#e2e8f0;padding:10px 12px;font-weight:800;cursor:pointer}
.actBtn.link{background:#eef2ff;color:#2563eb}

/* ç¯è™Ÿæ¨™ç±¤ï¼ˆåˆ†æ•¸ï¼‰ */
.lamp{border-radius:999px;color:#fff;font-weight:900;padding:6px 10px}
.lamp.green{background:#22c55e}
.lamp.blue{background:#3b82f6}
.lamp.amber{background:#f59e0b}
.lamp.red{background:#ef4444}

/* ---- Modal (ç•¶åœ°ç‹€æ³) ---- */
.modal-mask{position:fixed;inset:0;background:rgba(15,23,42,.45);display:none;align-items:center;justify-content:center;z-index:50}
.modal{background:#fff;border-radius:16px;box-shadow:0 20px 50px rgba(15,23,42,.2);width:min(720px,92vw);padding:18px}
.modal-hd{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.modal-hd h4{margin:0;font-size:20px}
.modal-close{border:none;background:#f1f5f9;border-radius:10px;padding:8px 10px;cursor:pointer}
.modal-sec{background:#f8fafc;border-radius:12px;padding:12px;margin-top:10px}
.modal-row{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
.tag.ok{background:var(--ok-bg);color:var(--ok)}
.tag.warn{background:var(--warn-bg);color:var(--warn)}
.tag.danger{background:var(--danger-bg);color:var(--danger)}
.tag.info{background:var(--info-bg);color:#2563eb}
.link-like{color:#2563eb;text-decoration:none;font-weight:700}

/* å°å­— */
.muted{color:var(--muted);font-size:13px}
</style>
</head>
<body>
  <div class="header">
    <div class="wrap">
      <div class="title">TripRadar</div>
      <div class="sub">è¡Œå‰ 1 åˆ†é˜ï½œå»ºè­°æ—…éŠåˆ†æ•¸ + äº¤é€šèˆ‡ç½å®³é¢¨éšª</div>
    </div>
  </div>

  <div class="wrap panel">
    <div class="row" style="align-items:center;justify-content:space-between">
      <div class="row">
        <div id="lastTs" class="badge">æ›´æ–°æ™‚é–“ï¼šâ€”</div>
        <button id="btnReload" class="btn brand">é‡æ–°æŠ“å–</button>
      </div>
      <div class="legend">
        <span class="dot green"></span> â‰¥90 éå¸¸é©åˆ
        <span class="dot blue"></span> 75â€“89 é©åˆ
        <span class="dot amber"></span> 60â€“74 å°šå¯
        <span class="dot red"></span> &lt;60 å»ºè­°æ”¹æœŸ
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <label class="badge">
        <input id="useLoc" type="checkbox" checked style="transform:scale(1.2);margin-right:8px"> ä½¿ç”¨æ‰€åœ¨åœ°åŠ æ¬Š
      </label>
      <div class="badge" style="padding:0">
        <select id="citySel" class="select" style="border:none">
          <option>å°åŒ—å¸‚</option><option selected>æ–°åŒ—å¸‚</option><option>æ¡ƒåœ’å¸‚</option>
          <option>æ–°ç«¹å¸‚</option><option>æ–°ç«¹ç¸£</option><option>è‹—æ —ç¸£</option>
          <option>å°ä¸­å¸‚</option><option>å½°åŒ–ç¸£</option><option>å—æŠ•ç¸£</option>
          <option>é›²æ—ç¸£</option><option>å˜‰ç¾©å¸‚</option><option>å˜‰ç¾©ç¸£</option>
          <option>å°å—å¸‚</option><option>é«˜é›„å¸‚</option><option>å±æ±ç¸£</option>
          <option>å®œè˜­ç¸£</option><option>èŠ±è“®ç¸£</option><option>å°æ±ç¸£</option>
          <option>æ¾æ¹–ç¸£</option><option>é‡‘é–€ç¸£</option><option>é€£æ±Ÿç¸£</option>
        </select>
      </div>
    </div>

    <div class="row muted" style="margin-top:8px">
      è³‡æ–™ä¾†æºï¼ˆå±•ç¤º/å¿«å–/æ¨¡æ“¬ï¼‰ï¼š<span class="badge">CWBï¼šå¤©æ°£</span>
      <span class="badge">MoENVï¼šAQI</span><span class="badge">NCDRï¼šç½å®³ CAP</span>
      <span class="badge">TDXï¼šè½‰ä¹˜/è·¯æ³</span>
    </div>

    <div id="grid" class="grid" style="margin-top:12px"></div>
  </div>

  <!-- ç•¶åœ°ç‹€æ³ Modal -->
  <div id="modalMask" class="modal-mask" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modal-hd">
        <h4 id="modalTitle">ç•¶åœ°ç‹€æ³</h4>
        <button class="modal-close" id="modalClose">âœ•</button>
      </div>
      <div class="modal-sec" id="modalSummary"></div>
      <div class="modal-sec">
        <div style="font-weight:800">ç½å®³é¢¨éšª</div>
        <div class="modal-row" id="modalDisaster"></div>
      </div>
      <div class="modal-sec">
        <div style="font-weight:800">äº¤é€šç‹€æ³</div>
        <div class="modal-row" id="modalTraffic"></div>
      </div>
      <div class="modal-sec">
        <div style="font-weight:800">å»ºè­°è¡Œå‹•</div>
        <div id="modalAdvice"></div>
        <div style="margin-top:8px" class="muted">
          è³‡æ–™ä¾†æºï¼šNCDRï¼ˆç½é˜²å‘Šè­¦ CAPï¼‰ã€TDXï¼ˆè·¯æ³/é‹è¼¸ï¼‰ã€‚ç›®å‰ç‚ºå±•ç¤º/æ¨¡æ“¬æ¨¡å¼ï¼›è‹¥éœ€çœŸå¯¦é€£ç·šï¼Œ
          è«‹æ–¼æœ¬é  <code>CONFIG.api</code> è¨­å®š proxyã€‚
        </div>
      </div>
    </div>
  </div>

<script>
/* ------------------------------ CONFIG ------------------------------- */
const CONFIG = {
  api: {
    // è‹¥éƒ¨ç½²äº† Cloudflare Workersï¼Œå¡«ä¸Šä½ çš„ proxy URLï¼ˆä¾‹ï¼š https://trip-proxy.your.workers.devï¼‰
    NCDR: '',   // '/api/ncdr?county=èŠ±è“®ç¸£' ç”± Workers è½‰ç™¼
    TDX:  '',   // '/api/tdx?type=traffic&county=èŠ±è“®ç¸£'
  },
  weights: { T:0.25, R:0.35, A:0.25, U:0.15 },
  distPenalty: { near:+2, sameCity:+5, far:-5 },    // æ‰€åœ¨åœ°åŠ æ¬Šï¼ˆç¤ºæ„ï¼‰
  riskPenalty: { none:0, watch:-5, warn:-15 },      // ç½å®³
  trafficPenalty: { smooth:0, jam:-5, heavy:-12 },  // äº¤é€š
};

const SPOTS = [
  { name:'é˜¿é‡Œå±±', region:'å˜‰ç¾©ç¸£', lat:23.51, lng:120.80, url:'https://www.ali-nsa.net/' },
  { name:'å¤ªé­¯é–£', region:'èŠ±è“®ç¸£', lat:24.16, lng:121.62, url:'https://www.taroko.gov.tw/' },
  { name:'æ—¥æœˆæ½­', region:'å—æŠ•ç¸£', lat:23.86, lng:120.91, url:'https://www.sunmoonlake.gov.tw/' },
  { name:'è¥¿æ‹‰é›…', region:'å°å—å¸‚', lat:23.13, lng:120.39, url:'https://www.siraya-nsa.gov.tw/' },
  { name:'é¦¬ç¥–',   region:'é€£æ±Ÿç¸£', lat:26.16, lng:119.94, url:'https://www.matsu-nsa.gov.tw/' },
  { name:'æ¾æ¹–',   region:'æ¾æ¹–ç¸£', lat:23.57, lng:119.56, url:'https://www.penghu-nsa.gov.tw/' },
  { name:'æ±éƒ¨æµ·å²¸', region:'å°æ±ç¸£', lat:22.85, lng:121.15, url:'https://www.eastcoast-nsa.gov.tw/' },
  { name:'èŠ±æ±ç¸±è°·', region:'èŠ±è“®ç¸£', lat:23.36, lng:121.36, url:'https://www.erv-nsa.gov.tw/' },
  { name:'åŒ—æµ·å²¸åŠè§€éŸ³å±±', region:'æ–°åŒ—å¸‚', lat:25.27, lng:121.51, url:'https://www.northguan-nsa.gov.tw/' },
  { name:'é‡‘é–€',   region:'é‡‘é–€ç¸£', lat:24.43, lng:118.33, url:'https://www.kinmen-nsa.gov.tw/' },
  { name:'é›ªéœ¸å…¬åœ’', region:'æ–°ç«¹ç¸£', lat:24.38, lng:121.10, url:'https://www.spnp.gov.tw/' },
  { name:'èŒ‚æ—',   region:'é«˜é›„å¸‚', lat:22.88, lng:120.68, url:'https://www.maolin-nsa.gov.tw/' },
  { name:'æ±åŒ—è§’æš¨å®œè˜­æµ·å²¸', region:'å®œè˜­ç¸£', lat:24.91, lng:121.91, url:'https://www.necoast-nsa.gov.tw/' },
];

/* ---- æ¨¡æ“¬ï¼šç½å®³/äº¤é€š ç­‰ç´šï¼ˆ0=ç„¡/é †æš¢ 1=æ³¨æ„/å£…å¡ 2=è­¦å ±/åš´é‡ï¼‰å¯è‡¨æ™‚æ”¹å€¼ç¤ºç¯„ ---- */
let demoDisaster = { 'èŠ±è“®ç¸£':2, 'å—æŠ•ç¸£':1, 'å°æ±ç¸£':1 };        // è¿‘æœŸå¤©å€™ç¤ºæ„
let demoTraffic  = { 'æ–°åŒ—å¸‚':1, 'å°ä¸­å¸‚':1, 'å—æŠ•ç¸£':2 };

/* ---- ç½å®³/äº¤é€šæ–‡å­— ---- */
const DISASTER_TEXT = {
  0:{tag:'ok',   label:'ç„¡æ˜é¡¯è­¦è¨Š', desc:'ç›®å‰ç„¡è±ªé›¨/åœŸçŸ³æµç­‰é¡¯è‘—é¢¨éšªã€‚'},
  1:{tag:'warn', label:'æ³¨æ„',       desc:'è±ªé›¨/é›·é›¨æ³¨æ„ï¼Œå±±å€ç•™æ„è½çŸ³èˆ‡åœ°æ»‘ã€‚'},
  2:{tag:'danger',label:'è­¦å ±',      desc:'å·²ç™¼å¸ƒè­¦å ±ï¼Œå¼·çƒˆå»ºè­°æ”¹æœŸæˆ–æ›´å‹•è¡Œç¨‹ã€‚'},
};
const TRAFFIC_TEXT = {
  0:{tag:'ok',   label:'è·¯æ³é †æš¢', desc:'ä¸»è¦å¹¹é“è¡Œè»Šé †æš¢ã€‚'},
  1:{tag:'warn', label:'å£…å¡',     desc:'æ˜“å£…å¡è·¯æ®µï¼Œå»ºè­°é›¢å³°æˆ–èµ°æ›¿ä»£é“è·¯ã€‚'},
  2:{tag:'danger',label:'åš´é‡å£…å¡', desc:'é ä¼°å»¶é² 30â€“60 åˆ†ä»¥ä¸Šï¼Œå»ºè­°èª¿æ•´æ™‚æ®µ/æ”¹ç·šã€‚'},
};

/* ------------------------------ UTIL ------------------------------- */
const $ = sel => document.querySelector(sel);
const $$ = sel => [...document.querySelectorAll(sel)];
function clamp(x,min,max){ return Math.max(min,Math.min(max,x)); }

/* --------- æ¨¡æ“¬/å¿«å–è³‡æ–™ï¼ˆå¤©æ°£/AQIï¼‰--------- */
/* ç°¡åŒ–ï¼šç¤ºç¯„å›ºå®šå€¼ï¼Œå¦‚æœä½ å·²æœ‰ v5 å…ˆå‰çš„æŠ“å–å‡½å¼ï¼Œå¯æ²¿ç”¨åŸå‡½å¼ */
function mockWeather(sp){
  return { T:24, POP:20, UV:6, AQI:45 }; // å¯æ›¿æ›ç‚ºä½ æ—¢æœ‰çš„ API çµæœ
}

/* --------- çœŸå¯¦ APIï¼ˆé¸ç”¨ï¼‰ï¼šç”± Cloudflare Workers è½‰ç™¼ --------- */
async function fetchDisasterReal(county){
  if(!CONFIG.api.NCDR) return null;
  try{
    const r=await fetch(`${CONFIG.api.NCDR}/api/ncdr?county=${encodeURIComponent(county)}`,{cache:'no-store'});
    if(!r.ok) throw 0;
    const {level}=await r.json(); // 0/1/2
    return level;
  }catch{ return null; }
}
async function fetchTrafficReal(county){
  if(!CONFIG.api.TDX) return null;
  try{
    const r=await fetch(`${CONFIG.api.TDX}/api/tdx?type=traffic&county=${encodeURIComponent(county)}`,{cache:'no-store'});
    if(!r.ok) throw 0;
    const {level}=await r.json(); // 0/1/2
    return level;
  }catch{ return null; }
}

/* --------------------------- Score --------------------------- */
function baseScore(w){  // æœªåŠ æ¬Š
  const {T,R,A,U}=CONFIG.weights;
  // è½‰æ›è¦å‰‡å¯æ›¿æ›ç‚ºä½ æ—¢æœ‰çš„ï¼ˆæˆ‘ä¿æŒèˆ‡ä½  v5 ä¸€è‡´çš„ç²¾ç¥ï¼‰
  let sT = 100 - Math.abs(24 - w.T) * 6;  // 18â€“28Â°C æœ€èˆ’é©ï¼Œåé›¢æ¯ 1Â°C æ‰£ 6 åˆ†
  let sR = 100 - w.POP;                   // é™é›¨æ©Ÿç‡ 100â†’0
  let sA = 100 - Math.max(0,w.AQI-30)*0.8;// AQI æ¯ +1 â†’ -0.8
  let sU = 70;                            // UV é è¨­ 70
  const score = (sT*T + sR*R + sA*A + sU*U)/1.0;
  return clamp(Math.round(score),0,100);
}
function locationBoost(city, sp){
  if(!$('#useLoc').checked) return 0;
  if(sp.region===city) return CONFIG.distPenalty.sameCity;
  // ç²—ç•¥ï¼šåŒå³¶ +2ã€è·¨æµ· -5
  const island = r=> ['æ¾æ¹–ç¸£','é‡‘é–€ç¸£','é€£æ±Ÿç¸£'].includes(r) ? 'outer' : 'main';
  return island(sp.region)===island(city) ? CONFIG.distPenalty.near : CONFIG.distPenalty.far;
}
function riskPenalty(disLevel){ // 0/1/2
  return [CONFIG.riskPenalty.none, CONFIG.riskPenalty.watch, CONFIG.riskPenalty.warn][disLevel??0];
}
function trafficPenalty(trLevel){ // 0/1/2
  return [CONFIG.trafficPenalty.smooth, CONFIG.trafficPenalty.jam, CONFIG.trafficPenalty.heavy][trLevel??0];
}
function finalScore(base, city, sp, disLv, trLv){
  let s = base + locationBoost(city, sp) + riskPenalty(disLv) + trafficPenalty(trLv);
  return clamp(s,0,100);
}
function lampOf(s){
  if(s>=90) return {cls:'green', text:'éå¸¸é©åˆå‡ºéŠ'};
  if(s>=75) return {cls:'blue',  text:'é©åˆå‡ºéŠ'};
  if(s>=60) return {cls:'amber', text:'å°šå¯å‡ºéŠ'};
  return {cls:'red', text:'å»ºè­°æ”¹æœŸ'};
}

/* --------------------------- åœ°åœ–èˆ‡ç¶²ç«™ --------------------------- */
function openMapAt(lat,lng){ window.open(`https://maps.google.com/?q=${lat},${lng}`,'_blank'); }
function navTo(lat,lng){ window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`,'_blank'); }

/* --------------------------- ç•¶åœ°ç‹€æ³ Modal --------------------------- */
function openModal(){ $('#modalMask').style.display='flex'; }
function closeModal(){ $('#modalMask').style.display='none'; }
$('#modalClose').onclick=closeModal;
$('#modalMask').addEventListener('click',e=>{ if(e.target.id==='modalMask') closeModal(); });

function showRegionStatus(sp, disLv, trLv){
  const d = DISASTER_TEXT[disLv??0];
  const t = TRAFFIC_TEXT[trLv??0];

  $('#modalTitle').textContent = `${sp.region} Â· ${sp.name} Â· ç•¶åœ°ç‹€æ³`;
  $('#modalSummary').innerHTML =
    `<span class="tag ${d.tag}">ç½å®³ï¼š${d.label}</span>
     <span class="tag ${t.tag}">äº¤é€šï¼š${t.label}</span>
     <span class="tag info"><a class="link-like" href="${sp.url}" target="_blank" rel="noopener">å®˜æ–¹ç¶²ç«™</a></span>`;

  $('#modalDisaster').innerHTML = `<span class="tag ${d.tag}">${d.label}</span><div>${d.desc}</div>`;
  $('#modalTraffic').innerHTML  = `<span class="tag ${t.tag}">${t.label}</span><div>${t.desc}</div>`;

  let tips=[];
  if(disLv===2) tips.push('ç½å®³å·²é”è­¦å ±ï¼Œå»ºè­°æ”¹æœŸæˆ–æ”¹ç‚ºå®¤å…§/ä½é¢¨éšªæ´»å‹•ã€‚');
  else if(disLv===1) tips.push('å‚™å¦¥é›¨å…·ã€é˜²æ»‘é‹ï¼Œå±±å€è·¯æ®µç•™æ„è½çŸ³èˆ‡åœ°æ»‘ã€‚');
  if(trLv===2) tips.push('é¿é–‹å°–å³°ï¼Œæ”¹èµ°æ›¿ä»£é“è·¯æˆ–èª¿æ•´å‡ºç™¼æ™‚æ®µï¼Œé ç•™ >60 åˆ†ç·©è¡ã€‚');
  else if(trLv===1) tips.push('å£…å¡è·¯æ®µæ˜“å»¶èª¤ï¼Œå»ºè­°é›¢å³°é€²å‡ºã€‚');
  if(!tips.length) tips.push('æ¢ä»¶è‰¯å¥½ï¼Œä»å»ºè­°æ”œå¸¶åŸºæœ¬å®‰å…¨è£å‚™èˆ‡å……è¶³æ°´åˆ†ã€‚');

  $('#modalAdvice').innerHTML = `<ul style="margin:6px 0 0 18px">${tips.map(x=>`<li>${x}</li>`).join('')}</ul>`;
  openModal();
}

/* --------------------------- Render --------------------------- */
async function loadAndRender(){
  $('#lastTs').textContent = `æ›´æ–°æ™‚é–“ï¼š${new Date().toLocaleString('zh-TW',{hour12:false})}`;
  const city = $('#citySel').value;
  const grid = $('#grid'); grid.innerHTML='';

  for(const sp of SPOTS){
    const w = mockWeather(sp);                 // ä½ å¯æ›¿æ›ç‚ºæ—¢æœ‰å¤©æ°£/AQI å‡½å¼
    const base = baseScore({T:w.T, POP:w.POP, AQI:w.AQI, U:w.UV});

    // å–å¾—ç½å®³/äº¤é€šï¼ˆçœŸå¯¦â†’å¦å‰‡ç”¨ demoï¼‰
    let disLv = await fetchDisasterReal(sp.region); if(disLv==null) disLv = demoDisaster[sp.region] ?? 0;
    let trLv  = await fetchTrafficReal(sp.region);  if(trLv==null)  trLv  = demoTraffic[sp.region]  ?? 0;

    const s = finalScore(base, city, sp, disLv, trLv);
    const lamp = lampOf(s);

    const card = document.createElement('div');
    card.className='card';
    card.innerHTML = `
      <div class="card-hd">
        <div>
          <div class="card-ttl">${sp.name}</div>
          <div class="muted">${sp.region}</div>
        </div>
        <div class="score-pill"><span class="lamp ${lamp.cls}">å»ºè­°æ—…éŠåˆ†æ•¸ ${s}</span></div>
      </div>

      <div class="metrics">
        <div class="tag">ğŸŒ¡ï¸ ${w.T}Â°C</div>
        <div class="tag">ğŸŒ§ï¸ ${w.POP}%</div>
        <div class="tag">â˜€ï¸ UV ${w.UV}</div>
        <div class="tag">ğŸ«§ AQI ${w.AQI}</div>
      </div>

      <div class="sugg">ğŸ‘‰ ${lamp.text}</div>

      <div class="acts">
        <button class="actBtn" data-act="pin">ğŸ“ ä¸€éµåˆ°é»</button>
        <button class="actBtn" data-act="nav">ğŸ—ºï¸ åœ°åœ–å°èˆª</button>
        <a class="actBtn link" href="${sp.url}" target="_blank" rel="noopener">ğŸ“„ å®˜æ–¹ç¶²ç«™</a>
        <button class="actBtn" data-act="status">ğŸš¦ ç•¶åœ°ç‹€æ³</button>
      </div>
    `;

    card.querySelector('[data-act="pin"]').onclick = ()=>openMapAt(sp.lat,sp.lng);
    card.querySelector('[data-act="nav"]').onclick = ()=>navTo(sp.lat,sp.lng);
    card.querySelector('[data-act="status"]').onclick = ()=>showRegionStatus(sp, disLv, trLv);

    grid.appendChild(card);
  }
}

$('#btnReload').onclick = loadAndRender;
$('#useLoc').onchange = loadAndRender;
$('#citySel').onchange = loadAndRender;

window.addEventListener('load',loadAndRender);
</script>
</body>
</html>
