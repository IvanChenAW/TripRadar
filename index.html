<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>TripRadarï½œApp ä»‹é¢ï¼ˆGitHub Pagesï¼‰</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;800&display=swap" rel="stylesheet">
<meta name="description" content="TripRadarï¼šè¡Œå‰ 1 åˆ†é˜ï¼Œä¸€çœ¼çœ‹å‡ºæ—…éŠèˆ’é©åº¦ã€‚çµåˆæ°£è±¡ç½²èˆ‡ç’°å¢ƒéƒ¨ OpenDataï¼Œè‡ªå‹•è¨ˆç®—å»ºè­°æ—…éŠåˆ†æ•¸èˆ‡ä¸€å¥å»ºè­°ã€‚">
<style>
:root{--bg:#F6F8FB;--card:#fff;--ink:#0f172a;--muted:#64748b;--blue:#1F6FEB;--green:#16a34a;--teal:#22c55e;--amber:#f59e0b;--red:#ef4444;--shadow:0 10px 28px rgba(2,6,23,.08)}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:"Noto Sans TC",system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue","PingFang TC","Microsoft JhengHei",sans-serif}
.wrap{display:flex;justify-content:center}
.phone{width:100%;max-width:430px;min-height:100dvh;background:linear-gradient(#fff,#fff0)}
.header{position:sticky;top:0;z-index:10;background:linear-gradient(#fff,#ffffffd0);backdrop-filter:saturate(1.2) blur(6px);padding:16px 16px 10px;border-bottom:1px solid #e5e7eb}
.h1{margin:0;font-size:20px;font-weight:800} .sub{margin:4px 0 0;color:var(--muted);font-size:12px}
.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0 0}
select,.switch,.pill{border:1px solid #d1d5db;background:#fff;border-radius:12px;padding:6px 10px;font-size:13px}
.badge{border:1px solid #c7d2fe;background:#eef2ff;color:#1e293b;border-radius:999px;padding:4px 10px;font-size:12px}
.status{margin:10px 16px;color:#334155;background:#f1f5f9;border:1px dashed #cbd5e1;padding:10px;border-radius:12px}
.cards{display:grid;grid-template-columns:1fr;gap:12px;padding:12px 16px 90px}
.card{background:var(--card);border:1px solid #e5e7eb;border-radius:16px;box-shadow:var(--shadow);padding:14px;display:flex;flex-direction:column;gap:8px}
.row{display:flex;align-items:center;justify-content:space-between;gap:8px}
.title{font-weight:800}
.tip{color:var(--muted);font-size:12px}
.score{padding:6px 10px;border-radius:999px;color:#fff;font-weight:800;font-size:12px}
.score.good{background:var(--green)} .score.ok{background:var(--teal)} .score.warn{background:var(--amber)} .score.bad{background:var(--red)}
.chips{display:flex;gap:6px;flex-wrap:wrap}
.chip{font-size:12px;background:#eef2ff;color:#3730a3;padding:4px 8px;border-radius:999px;border:1px solid #c7d2fe}
.btn{width:100%;border:none;background:var(--blue);color:#fff;border-radius:12px;padding:12px 14px;font-weight:800;cursor:pointer}
.footer{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid #e5e7eb;padding:8px 16px;color:#muted;font-size:12px}
.nav{position:fixed;left:0;right:0;bottom:42px;background:#fff;border-top:1px solid #e5e7eb;display:flex;gap:8px;justify-content:space-around;padding:10px 8px}
.nav button{flex:1;border:none;background:#f3f4f6;border-radius:12px;padding:10px 0}
.legend{display:flex;gap:10px;flex-wrap:wrap;font-size:12px;color:#334155;margin:0 16px 8px}
.legend .b{display:flex;align-items:center;gap:6px}
.legend .dot{width:10px;height:10px;border-radius:999px;display:inline-block}
.dot.g{background:#16a34a}.dot.o{background:#22c55e}.dot.y{background:#f59e0b}.dot.r{background:#ef4444}
/* modal */
.backdrop{position:fixed;inset:0;background:rgba(15,23,42,.35);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
.modal{max-width:430px;width:100%;background:#fff;border-radius:16px;box-shadow:0 30px 80px rgba(2,6,23,.25);overflow:hidden;border:1px solid #e5e7eb}
.modal header{padding:12px 14px;border-bottom:1px solid #e5e7eb}
.modal main{padding:14px}
.block{background:#f8fafc;border:1px solid #e2e8f0;border-radius:12px;padding:10px;margin-top:10px}
.kv{display:flex;gap:6px;flex-wrap:wrap}
.k{background:#eef2ff;border:1px solid #c7d2fe;border-radius:999px;padding:4px 8px;font-size:12px;color:#1e293b}
.close{float:right;border:1px solid #d1d5db;background:#fff;border-radius:10px;padding:4px 8px}
</style>
</head>
<body>
<div class="wrap"><div class="phone">
  <div class="header">
    <div class="row">
      <div>
        <div class="h1">TripRadar</div>
        <div class="sub">è¡Œå‰ 1 åˆ†é˜ï½œå»ºè­°æ—…éŠåˆ†æ•¸ + ä¸€å¥å»ºè­°</div>
      </div>
      <div class="badge" id="ts">æ›´æ–°æ™‚é–“ï¼šâ€”</div>
    </div>
    <div class="controls">
      <label class="switch"><input type="checkbox" id="useLoc" checked> ä½¿ç”¨æ‰€åœ¨åœ°åŠ æ¬Š</label>
      <label>æ‰‹å‹•æ‰€åœ¨åœ°ï¼š
        <select id="manualCounty">
          <option>è‡ºåŒ—å¸‚</option><option>æ–°åŒ—å¸‚</option><option>åŸºéš†å¸‚</option><option>æ¡ƒåœ’å¸‚</option>
          <option>æ–°ç«¹å¸‚</option><option>æ–°ç«¹ç¸£</option><option>è‹—æ —ç¸£</option><option>è‡ºä¸­å¸‚</option>
          <option>å½°åŒ–ç¸£</option><option>å—æŠ•ç¸£</option><option>é›²æ—ç¸£</option><option>å˜‰ç¾©å¸‚</option><option>å˜‰ç¾©ç¸£</option>
          <option>è‡ºå—å¸‚</option><option>é«˜é›„å¸‚</option><option>å±æ±ç¸£</option><option>å®œè˜­ç¸£</option>
          <option>èŠ±è“®ç¸£</option><option>è‡ºæ±ç¸£</option><option>æ¾æ¹–ç¸£</option><option>é‡‘é–€ç¸£</option><option>é€£æ±Ÿç¸£</option>
        </select>
      </label>
      <span class="pill" id="mode">è³‡æ–™ä¾†æºï¼šCWB / MoENV / NCDR</span>
      <button class="pill" id="retry">é‡æ–°æŠ“å–</button>
    </div>
  </div>

  <div class="legend">
    <div class="b"><span class="dot g"></span> â‰¥90 éå¸¸é©åˆå‡ºéŠ</div>
    <div class="b"><span class="dot o"></span> 75â€“89 é©åˆå‡ºéŠ</div>
    <div class="b"><span class="dot y"></span> 60â€“74 å°šå¯å‡ºéŠ</div>
    <div class="b"><span class="dot r"></span> &lt;60 å»ºè­°æ”¹æœŸ</div>
  </div>

  <div class="status" id="status">æ­£åœ¨é€£ç·šæŠ“å–è³‡æ–™â€¦</div>
  <div class="cards" id="cards"></div>

  <div class="nav">
    <button data-tab="é¦–é ">é¦–é </button>
    <button data-tab="æ¢ç´¢">æ¢ç´¢</button>
    <button data-tab="è¨­å®š">è¨­å®š</button>
  </div>
  <div class="footer">Â© 2025 TripRadarï¼ˆDEMOï¼‰ã€‚æœ¬é ç‚º GitHub Pages å±•ç¤ºç”¨ï¼›è‹¥ç¶²è·¯ä¸ç©©ï¼Œç³»çµ±æœƒä»¥å¿«å–ç¤ºæ„å€¼å‘ˆç¾ã€‚</div>
</div></div>

<!-- è©³ç´°é  Modal -->
<div class="backdrop" id="backdrop" role="dialog" aria-modal="true">
  <div class="modal">
    <header>
      <b id="m-title">æ™¯å€</b>
      <button class="close" id="m-close">é—œé–‰ Ã—</button>
      <div class="sub" id="m-county">â€”</div>
    </header>
    <main>
      <div class="block">
        <b>å³æ™‚æŒ‡æ¨™</b>
        <div class="kv" id="m-kv" style="margin-top:6px"></div>
        <div style="margin-top:6px;color:#64748b;font-size:12px" id="m-ts">è³‡æ–™æ™‚é–“ï¼šâ€”</div>
      </div>
      <div class="block">
        <b>åˆ†æ•¸æ‹†è§£</b>
        <div id="m-break" style="margin-top:6px;font-size:14px;color:#334155"></div>
      </div>
      <div class="block">
        <b>ç†±é–€æ´»å‹•ï¼ˆæ¨¡æ“¬ï¼‰</b>
        <ul id="m-events" style="margin:6px 0 0 18px"></ul>
      </div>
    </main>
  </div>
</div>

<script>
/* ===== OpenData ä¾†æº ===== */
const CWB_KEY = "CWA-CD72AADF-7D43-445F-AFB8-A3F62F548EBF"; // å¯è‡ªè¡Œæ›´æ›
const CWB_FORECAST = `https://opendata.cwa.gov.tw/api/v1/rest/datastore/F-C0032-001?Authorization=${CWB_KEY}`;
const CWB_UVI      = `https://opendata.cwa.gov.tw/api/v1/rest/datastore/O-A0005-001?Authorization=${CWB_KEY}&format=JSON`;
const AQI_URL      = "https://data.moenv.gov.tw/api/v2/aqx_p_432?format=json";
const CAP_URL      = "https://alerts.ncdr.nat.gov.tw/JSONAtomFeeds";

/* 13 é¢¨æ™¯å€ */
const AREA = {
 "é˜¿é‡Œå±±":{county:"å˜‰ç¾©ç¸£",lat:23.5,lng:120.8},
 "å¤ªé­¯é–£":{county:"èŠ±è“®ç¸£",lat:24.2,lng:121.5},
 "æ—¥æœˆæ½­":{county:"å—æŠ•ç¸£",lat:23.86,lng:120.91},
 "è¥¿æ‹‰é›…":{county:"è‡ºå—å¸‚",lat:23.2,lng:120.4},
 "é¦¬ç¥–":{county:"é€£æ±Ÿç¸£",lat:26.16,lng:119.95,island:true},
 "æ¾æ¹–":{county:"æ¾æ¹–ç¸£",lat:23.57,lng:119.56,island:true},
 "æ±éƒ¨æµ·å²¸":{county:"è‡ºæ±ç¸£",lat:22.9,lng:121.2},
 "èŠ±æ±ç¸±è°·":{county:"èŠ±è“®ç¸£",lat:23.6,lng:121.4},
 "é‡‘é–€":{county:"é‡‘é–€ç¸£",lat:24.45,lng:118.38,island:true},
 "èŒ‚æ—":{county:"é«˜é›„å¸‚",lat:22.9,lng:120.7},
 "é›²å˜‰å—æ¿±æµ·":{county:"è‡ºå—å¸‚",lat:23.2,lng:120.1},
 "åŒ—æµ·å²¸åŠè§€éŸ³å±±":{county:"æ–°åŒ—å¸‚",lat:25.28,lng:121.5},
 "æ±åŒ—è§’æš¨å®œè˜­æµ·å²¸":{county:"å®œè˜­ç¸£",lat:24.9,lng:121.8}
};
const COUNTY_CENTER = {
 "è‡ºåŒ—å¸‚":[25.04,121.56],"æ–°åŒ—å¸‚":[25.05,121.46],"åŸºéš†å¸‚":[25.13,121.74],"æ¡ƒåœ’å¸‚":[24.99,121.31],
 "æ–°ç«¹å¸‚":[24.80,120.97],"æ–°ç«¹ç¸£":[24.74,121.10],"è‹—æ —ç¸£":[24.56,120.82],"è‡ºä¸­å¸‚":[24.16,120.67],
 "å½°åŒ–ç¸£":[24.07,120.54],"å—æŠ•ç¸£":[23.91,120.69],"é›²æ—ç¸£":[23.71,120.54],"å˜‰ç¾©ç¸£":[23.45,120.25],
 "å˜‰ç¾©å¸‚":[23.48,120.44],"è‡ºå—å¸‚":[23.00,120.22],"é«˜é›„å¸‚":[22.63,120.30],"å±æ±ç¸£":[22.55,120.62],
 "å®œè˜­ç¸£":[24.75,121.75],"èŠ±è“®ç¸£":[23.99,121.60],"è‡ºæ±ç¸£":[22.80,121.14],
 "æ¾æ¹–ç¸£":[23.57,119.56],"é‡‘é–€ç¸£":[24.45,118.38],"é€£æ±Ÿç¸£":[26.16,119.95]
};

/* å°å·¥å…· */
const $=q=>document.querySelector(q), $$=q=>Array.from(document.querySelectorAll(q));
function toNum(v){ const n=Number(v); return isFinite(n)?n:null; }
function avg(a,b){ if(a==null&&b==null)return null; if(a==null)return b; if(b==null)return a; return Math.round((a+b)/2); }
function pick(elements, key){
  const el = elements?.find(e=>e.elementName===key);
  const val = el?.time?.find?.(t => t?.parameter?.parameterName!=null)?.parameter?.parameterName;
  return val ?? null;
}
function haversine(a,b){ const R=6371, dLat=(b.lat-a.lat)*Math.PI/180, dLng=(b.lng-a.lng)*Math.PI/180;
  const s1=Math.sin(dLat/2)**2 + Math.cos(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*Math.sin(dLng/2)**2;
  return 2*R*Math.asin(Math.sqrt(s1));
}

/* è¨ˆåˆ† */
const W={ temp:0.25, rain:0.35, aqi:0.25, uv:0.15 };
const TH={ good:90, ok:75, warn:60 };
function baseScore(w){
  const t=(w.temp!=null)?((w.temp>=18&&w.temp<=28)?100:Math.max(0,100-Math.abs(w.temp-23)*6)):70;
  const r=(w.pop!=null)?(100-Math.min(100,w.pop)):70;
  const a=(w.aqi!=null)?Math.max(0,100-(w.aqi*0.8)):70;
  const u=(w.uv!=null)?Math.max(0,100-(w.uv*10)):70;
  const s=Math.round(t*W.temp + r*W.rain + a*W.aqi + u*W.uv);
  let tag="ok"; if(s>=TH.good)tag="good"; else if(s>=TH.ok)tag="ok"; else if(s>=TH.warn)tag="warn"; else tag="bad";
  return {score:s, tag, parts:{t,r,a,u}};
}
function advice(tag){ return tag==="good"?"éå¸¸é©åˆå‡ºéŠ":tag==="ok"?"é©åˆå‡ºéŠ":tag==="warn"?"å°šå¯å‡ºéŠ":"æ”¹å¤©å†å»æœƒæ›´å¥½"; }
function scoreClass(s){ if(s>=TH.good)return"good"; if(s>=TH.ok)return"ok"; if(s>=TH.warn)return"warn"; return"bad"; }

/* æ‰€åœ¨åœ°åŠ æ¬Š */
function weighting(raw, areaCounty, areaMeta){
  if(!$("#useLoc").checked) return {adj:raw, delta:0, reason:"ï¼ˆæœªå¥—ç”¨ï¼‰"};
  const uc=$("#manualCounty").value||"è‡ºåŒ—å¸‚";
  let delta=0, reason=[];
  if(uc===areaCounty){ delta+=5; reason.push("åŒç¸£å¸‚ +5"); }
  else{
    const aPt={lat:COUNTY_CENTER[areaCounty][0],lng:COUNTY_CENTER[areaCounty][1]};
    const uPt={lat:COUNTY_CENTER[uc][0],lng:COUNTY_CENTER[uc][1]};
    const d=haversine(uPt,aPt);
    if(d<120){ delta+=2; reason.push("è¿‘è· +2"); }
    else if(d>=200){ delta-=5; reason.push("é è· -5"); }
  }
  const userIsland=["æ¾æ¹–ç¸£","é‡‘é–€ç¸£","é€£æ±Ÿç¸£"].includes(uc);
  const areaIsland=!!areaMeta.island;
  if(userIsland!==areaIsland){ delta-=10; reason.push("é›¢å³¶æˆæœ¬ -10"); }
  return {adj:Math.max(0,Math.min(100,raw+delta)), delta, reason:reason.join("ã€")||"â€”"};
}

/* é€£ç·š */
async function getForecast(){
  const r=await fetch(CWB_FORECAST); if(!r.ok) throw new Error("CWB é å ±å¤±æ•—");
  const j=await r.json(); const out={};
  for(const loc of (j?.records?.location||[])){
    const c = loc.locationName;
    const pop12 = pick(loc.weatherElement,"PoP12h");
    const minT = toNum(pick(loc.weatherElement,"MinT"));
    const maxT = toNum(pick(loc.weatherElement,"MaxT"));
    out[c] = { temp:avg(minT,maxT), pop:toNum(pop12) };
  }
  return out;
}
async function getUVI(){
  const r=await fetch(CWB_UVI); if(!r.ok) throw new Error("CWB UVI å¤±æ•—");
  const j=await r.json(); const rows=j?.records?.location||j?.records?.station||j?.records||[], agg={};
  for(const row of rows){
    const c=row.parameter?.[0]?.parameterValue||row.county||row.locationName||row.parameter?.find?.(p=>p.parameterName==="COUNTY")?.parameterValue;
    const u=Number(row.weatherElement?.[0]?.elementValue||row.UVI||row.value);
    if(!c||!isFinite(u)) continue; if(!agg[c]) agg[c]={sum:0,n:0}; agg[c].sum+=u; agg[c].n++;
  }
  const out={}; for(const k in agg) out[k]=Math.round((agg[k].sum/agg[k].n)*10)/10; return out;
}
async function getAQI(){
  const r=await fetch(AQI_URL); if(!r.ok) throw new Error("AQI å¤±æ•—");
  const j=await r.json(); const out={};
  for(const row of (j?.records||[])){ const c=row.County||row.county, a=Number(row.AQI||row.aqi);
    if(!c||!isFinite(a)) continue; if(!out[c]) out[c]={sum:0,n:0}; out[c].sum+=a; out[c].n++;
  }
  const avg={}; for(const k in out) avg[k]=Math.round(out[k].sum/out[k].n); return avg;
}
async function getCAP(){
  try{ const r=await fetch(CAP_URL); if(!r.ok) throw 0; const j=await r.json();
    const arr=j?.entries||j?.feed||j||[]; return (arr.slice?arr.slice(0,3):[]).map(x=>x.title||x.summary||x.id).filter(Boolean);
  }catch{ return []; }
}

/* æ¸²æŸ“ */
const cardsEl=$("#cards"); let capTitles=[];
function render(dataset, mode="é€£ç·š"){
  cardsEl.innerHTML="";
  const ts=new Date().toISOString().slice(0,16).replace("T"," ");
  $("#ts").textContent=`æ›´æ–°æ™‚é–“ï¼š${ts}ï¼ˆ${mode}ï¼‰`;
  $("#status").style.display="none";
  Object.entries(AREA).forEach(([name,meta])=>{
    const county=meta.county;
    const w={
      temp:dataset.weather?.[county]?.temp ?? null,
      pop: dataset.weather?.[county]?.pop ?? null,
      uv:  dataset.uvi?.[county] ?? 6,
      aqi: dataset.aqi?.[county] ?? null
    };
    const b=baseScore(w);
    const {adj,delta,reason}=weighting(b.score, county, meta);

    const card=document.createElement("div"); card.className="card";
    card.innerHTML=`
      <div class="row">
        <div class="title">${name}</div>
        <div class="score ${scoreClass(adj)}">å»ºè­°æ—…éŠåˆ†æ•¸ ${adj}</div>
      </div>
      <div class="tip">${advice(scoreClass(adj))}ï½œåŸå§‹ ${b.score}${delta?`ï¼ˆÎ”${delta}ï¼‰`:''}</div>
      <div class="chips">
        <div class="chip">ğŸŒ¡ï¸ ${w.temp!=null?w.temp+"Â°C":"â€”"}</div>
        <div class="chip">â˜” ${w.pop!=null?w.pop+"%":"â€”"}</div>
        <div class="chip">ğŸ”† ${w.uv!=null?w.uv:"â€”"}</div>
        <div class="chip">ğŸ«§ AQI ${w.aqi!=null?w.aqi:"â€”"}</div>
        <div class="chip">${county}${capTitles.some(tt=>tt && tt.includes(county))?"ï½œCAP":""}</div>
      </div>
      <button class="btn open">æŸ¥çœ‹</button>
    `;
    card.querySelector(".open").addEventListener("click",()=>openModal(name, county, w, b, adj, delta, reason));
    cardsEl.appendChild(card);
  });
}
function openModal(name, county, w, baseObj, adj, delta, reason){
  $("#m-title").textContent=name; $("#m-county").textContent=county;
  $("#m-kv").innerHTML=`
    <span class="k">T ${w.temp!=null?w.temp+"Â°C":"â€”"}</span>
    <span class="k">POP ${w.pop!=null?w.pop+"%":"â€”"}</span>
    <span class="k">UV ${w.uv!=null?w.uv:"â€”"}</span>
    <span class="k">AQI ${w.aqi!=null?w.aqi:"â€”"}</span>
    <span class="k">åŸå§‹ ${baseObj.score}</span>
    <span class="k">åŠ æ¬Š ${adj}ï¼ˆÎ”${delta}ï½œ${reason}ï¼‰</span>`;
  $("#m-ts").textContent=$("#ts").textContent;
  $("#m-break").textContent=`æº«åº¦Ã—${W.temp}, é™é›¨Ã—${W.rain}, ç©ºå“Ã—${W.aqi}, UVÃ—${W.uv} â†’ ${baseObj.score}ï¼Œå†å¥—æ‰€åœ¨åœ°åŠ æ¬Š Î”${delta} = ${adj}`;
  const mock = {"å˜‰ç¾©ç¸£":["é˜¿é‡Œå±±æ—¥å‡º","æ—éµå¸‚é›†"],"èŠ±è“®ç¸£":["å¤ªé­¯é–£æ­¥é“æ—¥"],"å—æŠ•ç¸£":["æ—¥æœˆæ½­èŠ±ç«"],"è‡ºå—å¸‚":["è¥¿æ‹‰é›…è•éº¥å­£"],
    "é€£æ±Ÿç¸£":["è—çœ¼æ·šå­£"],"æ¾æ¹–ç¸£":["æ¾æ¹–èŠ±ç«"],"è‡ºæ±ç¸£":["æ±æµ·å²¸è—è¡“ç¯€"],"é‡‘é–€ç¸£":["æˆ°åœ°å°è¦½"],"é«˜é›„å¸‚":["èŒ‚æ—ç´«è¶"]};
  const ul=$("#m-events"); ul.innerHTML=""; (mock[county]||["ï¼ˆç›®å‰ç„¡è³‡æ–™ï¼‰"]).forEach(s=>{ const li=document.createElement("li"); li.textContent=s; ul.appendChild(li); });
  $("#backdrop").style.display="flex";
}
$("#m-close").addEventListener("click",()=>$("#backdrop").style.display="none");
$("#backdrop").addEventListener("click",(e)=>{ if(e.target.id==="backdrop") $("#backdrop").style.display="none"; });

/* è¼‰å…¥æµç¨‹ */
function showErr(msg){
  const s=$("#status"); s.className="status"; s.textContent="é€£ç·šç™¼ç”Ÿå•é¡Œï¼š"+msg+"ï¼ˆä»¥å¿«å–å€¼å‘ˆç¾ï¼‰";
  $("#mode").textContent="ç‹€æ…‹ï¼šå¿«å–";
}
async function load(){
  $("#status").className="status"; $("#status").textContent="æ­£åœ¨é€£ç·šæŠ“å–è³‡æ–™â€¦";
  $("#mode").textContent="è³‡æ–™ä¾†æºï¼šCWB / MoENV / NCDR";
  try{
    const [weather, aqi, uvi, caps] = await Promise.all([getForecast(), getAQI(), getUVI(), getCAP()]);
    capTitles = caps || [];
    render({weather, aqi, uvi}, "é€£ç·š");
  }catch(e){
    console.error(e); showErr(e.message||e);
    const weather={}, aqi={}, uvi={};
    Object.values(AREA).forEach(m=>{ weather[m.county]={temp:24,pop:20}; aqi[m.county]=45; uvi[m.county]=6; });
    capTitles=[];
    render({weather, aqi, uvi}, "å¿«å–");
  }
}
$("#retry").addEventListener("click",load);
$("#useLoc").addEventListener("change",load);
$("#manualCounty").addEventListener("change",load);
window.addEventListener("DOMContentLoaded",()=>{ load(); $$('.nav button').forEach(n=> n.onclick=()=>alert('ç¤ºæ„ï¼š'+n.dataset.tab)); });
</script>
</body>
</html>
