<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TripRadarï½œçœŸå¯¦ OpenData ç‰ˆ</title>
<style>
  :root{
    --bg:#f5f7fb; --card:#fff; --text:#0f172a; --muted:#64748b; --brand:#2563eb;
    --green:#16a34a; --blue:#2563eb; --amber:#d97706; --red:#dc2626;
    --chip:#eef2ff; --pill:#eef2ff; --shadow:0 10px 24px rgba(15,23,42,.08); --r:16px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:"Noto Sans TC",ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"PingFang TC","Microsoft JhengHei",Arial,sans-serif}
  header{background:linear-gradient(180deg,#3576ff 0%,#2c5df2 60%,#2248da 100%);color:#fff;padding:28px 20px 22px;position:sticky;top:0;z-index:10}
  .wrap{max-width:1200px;margin:0 auto}
  h1{margin:0;font-size:28px}
  .sub{opacity:.92;margin-top:6px}
  .toolbar{display:flex;gap:12px;flex-wrap:wrap;margin-top:16px}
  .btn{background:#fff;color:#0f172a;border:none;border-radius:999px;padding:10px 16px;font-weight:700;box-shadow:var(--shadow)}
  .btn:active{transform:translateY(1px)}
  .row{max-width:1200px;margin:16px auto 0;padding:0 16px;display:flex;gap:12px;flex-wrap:wrap}
  .ctl{background:var(--card);box-shadow:var(--shadow);border-radius:var(--r);padding:12px 14px;display:flex;gap:10px;align-items:center}
  .chip{background:#eaf1ff;color:#1e293b;padding:7px 12px;border-radius:999px;font-weight:700}
  .legend{max-width:1200px;margin:8px auto 0;padding:0 16px;display:flex;gap:10px;flex-wrap:wrap;color:#1f2937}
  .legend .item{display:flex;align-items:center;gap:8px;background:#fff;border-radius:999px;padding:8px 12px;box-shadow:var(--shadow);font-weight:700}
  .dot{width:10px;height:10px;border-radius:50%}
  .g{background:#16a34a}.b{background:#2563eb}.a{background:#d97706}.r{background:#dc2626}
  .grid{max-width:1200px;margin:12px auto;padding:0 16px;display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
  @media (max-width:1024px){.grid{grid-template-columns:repeat(8,1fr)}}
  @media (max-width:640px){.grid{grid-template-columns:repeat(4,1fr)}}
  .card{grid-column:span 6;background:#fff;box-shadow:var(--shadow);border-radius:var(--r);padding:18px}
  @media (max-width:640px){.card{grid-column:span 4}}
  .title{display:flex;justify-content:space-between;align-items:start;gap:10px}
  .title h3{margin:0;font-size:22px}
  .badge{border-radius:12px;padding:8px 12px;font-weight:800}
  .badge.green{background:#ecfdf5;color:#16a34a}
  .badge.blue{background:#eff6ff;color:#2563eb}
  .badge.amber{background:#fff7ed;color:#d97706}
  .badge.red{background:#fef2f2;color:#dc2626}
  .meta{color:#64748b;margin:6px 0 10px}
  .metrics{display:flex;flex-wrap:wrap;gap:10px;margin:8px 0 8px}
  .pill{background:#eef2ff;padding:8px 12px;border-radius:12px;font-weight:700}
  .acts{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .actBtn{border:1px solid #e5e7eb;background:#fff;border-radius:12px;padding:10px 12px;display:flex;gap:10px;align-items:center;cursor:pointer}
  .src{max-width:1200px;margin:10px auto 26px;padding:0 16px;color:#64748b}
  footer{color:#94a3b8;text-align:center;margin:30px 0 16px}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>TripRadar</h1>
    <div class="sub">è¡Œå‰ 1 åˆ†é˜ Â· å»ºè­°æ—…éŠåˆ†æ•¸ + ä¸€å¥å»ºè­°ï¼ˆçœŸå¯¦ API ç‰ˆï¼›å¤±æ•—è‡ªå‹•å›é€€ Demoï¼‰</div>
    <div class="toolbar">
      <button id="btnRefresh" class="btn">ğŸ”„ é‡æ–°æŠ“å–</button>
      <div id="txtTime" class="btn">ğŸ•’ æ›´æ–°æ™‚é–“ï¼šâ€”</div>
    </div>
  </div>
</header>

<section class="row">
  <div class="ctl">
    <input id="useGeo" type="checkbox" checked />
    <label for="useGeo"><b>ä½¿ç”¨æ‰€åœ¨åœ°åŠ æ¬Š</b></label>
  </div>
  <div class="ctl">
    <span>æ‰‹å‹•æ‰€åœ¨åœ°ï¼š</span>
    <select id="selCity"></select>
  </div>
  <div class="ctl chip" id="badgeCWB">CWBï¼šå¤©æ°£ï¼ˆé€£ç·šä¸­â€¦ï¼‰</div>
  <div class="ctl chip" id="badgeAQI">MoENVï¼šAQIï¼ˆé€£ç·šä¸­â€¦ï¼‰</div>
  <div class="ctl chip">NCDR / TDXï¼šå±•ç¤ºå…ˆå›é€€ï¼ˆå¯æ”¹ proxy å•Ÿç”¨ï¼‰</div>
</section>

<section class="legend">
  <div class="item"><span class="dot g"></span> â‰¥90 éå¸¸é©åˆå‡ºéŠ</div>
  <div class="item"><span class="dot b"></span> 75â€“89 é©åˆå‡ºéŠ</div>
  <div class="item"><span class="dot a"></span> 60â€“74 å°šå¯å‡ºéŠ</div>
  <div class="item"><span class="dot r"></span> &lt;60 å»ºè­°æ”¹æœŸ</div>
</section>

<section id="cards" class="grid"></section>
<div class="src wrap">è³‡æ–™æºï¼šCWB F-C0032-001ï¼ˆç¸£å¸‚é å ±ï¼‰ã€MoENV AQIï¼ˆaqx_p_432ï¼‰ã€‚æ­¤é é¢æ¡ã€Œå‰ç«¯ç›´é€£ã€ï¼›è‹¥ CORS æˆ–æˆæ¬Šå—é™ï¼Œç³»çµ±æœƒå›é€€å±•ç¤ºå€¼ä»¥ç¢ºä¿ Demo é †æš¢ã€‚</div>
<footer>Â© 2025 TripRadarï¼ˆDEMOï¼‹Live æ··åˆï¼‰</footer>

<script>
/* ========= å¯é¸ï¼šåœ¨é€™è£¡å¡«å…¥ä½ çš„é‡‘é‘° / proxy ========= */
// â†ï¼ˆå»ºè­°å…ˆç©ºç™½è®“å®ƒå›é€€ Demoï¼›è¦ç›´æ’­å†å¡«ï¼‰
// CWBï¼šåˆ° https://opendata.cwa.gov.tw/ ç”³è«‹
const CWB_TOKEN = "";   // ä¾‹ï¼š'CWA-XXXX'
// MoENVï¼šåˆ° https://data.moenv.gov.tw/ ç”³è«‹ï¼ˆæˆ–ç•™ç©ºæ”¹ç”¨é–‹æ”¾åŒ¿åï¼‰
const MOENV_API_KEY = ""; // ä¾‹ï¼š'YOUR-KEY'
// è‹¥ä½ æœ‰è‡ªå·±çš„ proxyï¼Œå¯æŠŠ URL å¯«åœ¨é€™ï¼ˆä¾‹å¦‚ Cloudflare Workersï¼‰ï¼š
const NCDR_PROXY = "";   // ä¾‹ï¼š'https://yourproxy.example.com/ncdr?url='
const TDX_PROXY  = "";   // ä¾‹ï¼š'https://yourproxy.example.com/tdx?path='

/* ========= å›é€€ Demo çš„ä¿åº•é–‹é—œ ========= */
const DEMO_MODE_FALLBACK = true;

/* ========= ç¸£å¸‚æ¸…å–® ========= */
const CITIES = ["è‡ºåŒ—å¸‚","æ–°åŒ—å¸‚","åŸºéš†å¸‚","æ¡ƒåœ’å¸‚","æ–°ç«¹å¸‚","æ–°ç«¹ç¸£","è‹—æ —ç¸£","è‡ºä¸­å¸‚","å½°åŒ–ç¸£","å—æŠ•ç¸£","é›²æ—ç¸£","å˜‰ç¾©ç¸£","å˜‰ç¾©å¸‚","è‡ºå—å¸‚","é«˜é›„å¸‚","å±æ±ç¸£","å®œè˜­ç¸£","èŠ±è“®ç¸£","è‡ºæ±ç¸£","æ¾æ¹–ç¸£","é‡‘é–€ç¸£","é€£æ±Ÿç¸£"];
const selCity = document.getElementById('selCity');
selCity.innerHTML = CITIES.map(c=>`<option>${c}</option>`).join('');
selCity.value="æ–°ç«¹å¸‚";

/* ========= 13 è™•é¢¨æ™¯å€ ========= */
const spots = [
  { name:"é˜¿é‡Œå±±", region:"å˜‰ç¾©ç¸£", lat:23.508, lng:120.81, url:"https://www.ali-nsa.net/"},
  { name:"å¤ªé­¯é–£", region:"èŠ±è“®ç¸£", lat:24.18, lng:121.49, url:"https://www.taroko.gov.tw/"},
  { name:"æ—¥æœˆæ½­", region:"å—æŠ•ç¸£", lat:23.86, lng:120.91, url:"https://www.sunmoonlake.gov.tw/"},
  { name:"è¥¿æ‹‰é›…", region:"è‡ºå—å¸‚", lat:23.18, lng:120.40, url:"https://www.siraya-nsa.gov.tw/"},
  { name:"èŠ±æ±ç¸‘è°·", region:"èŠ±è“®ç¸£", lat:23.90, lng:121.54, url:"https://www.erv-nsa.gov.tw/"},
  { name:"æ±éƒ¨æµ·å²¸", region:"è‡ºæ±ç¸£", lat:22.90, lng:121.16, url:"https://www.eastcoast-nsa.gov.tw/"},
  { name:"åŒ—æµ·å²¸åŠè§€éŸ³å±±", region:"æ–°åŒ—å¸‚", lat:25.28, lng:121.56, url:"https://www.northguan-nsa.gov.tw/"},
  { name:"èŒ‚æ—", region:"é«˜é›„å¸‚", lat:22.88, lng:120.68, url:"https://www.maolin-nsa.gov.tw/"},
  { name:"æ¾æ¹–", region:"æ¾æ¹–ç¸£", lat:23.57, lng:119.56, url:"https://www.penghu-nsa.gov.tw/"},
  { name:"é¦¬ç¥–", region:"é€£æ±Ÿç¸£", lat:26.16, lng:119.93, url:"https://www.matsu-nsa.gov.tw/"},
  { name:"é›²å˜‰å—æ¿±æµ·", region:"é›²æ—ç¸£", lat:23.37, lng:120.15, url:"https://www.swcoast-nsa.gov.tw/"},
  { name:"é‡‘é–€", region:"é‡‘é–€ç¸£", lat:24.45, lng:118.39, url:"https://www.kinmen-nsa.gov.tw/"},
  { name:"æ±åŒ—è§’æš¨å®œè˜­æµ·å²¸", region:"å®œè˜­ç¸£", lat:24.98, lng:121.91, url:"https://www.necoast-nsa.gov.tw/"}
];

/* ========= Demo å€¼ï¼ˆä¿åº•ï¼‰ ========= */
const demoWeather = {
  "å˜‰ç¾©ç¸£":{temp:24,pop:20,uv:6,aqi:45},"èŠ±è“®ç¸£":{temp:25,pop:30,uv:7,aqi:50},
  "å—æŠ•ç¸£":{temp:23,pop:25,uv:7,aqi:40},"è‡ºå—å¸‚":{temp:26,pop:10,uv:8,aqi:55},
  "è‡ºæ±ç¸£":{temp:26,pop:15,uv:8,aqi:35},"æ–°åŒ—å¸‚":{temp:24,pop:20,uv:6,aqi:48},
  "é«˜é›„å¸‚":{temp:27,pop:20,uv:9,aqi:60},"æ¾æ¹–ç¸£":{temp:25,pop:10,uv:8,aqi:38},
  "é€£æ±Ÿç¸£":{temp:20,pop:15,uv:5,aqi:30},"é›²æ—ç¸£":{temp:25,pop:20,uv:7,aqi:50},
  "é‡‘é–€ç¸£":{temp:22,pop:10,uv:6,aqi:32},"å®œè˜­ç¸£":{temp:23,pop:35,uv:6,aqi:42}
};
const demoDisaster = {"å˜‰ç¾©ç¸£":0,"èŠ±è“®ç¸£":0,"å—æŠ•ç¸£":0,"è‡ºå—å¸‚":0,"è‡ºæ±ç¸£":0,"æ–°åŒ—å¸‚":0,"é«˜é›„å¸‚":0,"æ¾æ¹–ç¸£":0,"é€£æ±Ÿç¸£":0,"é›²æ—ç¸£":1,"é‡‘é–€ç¸£":0,"å®œè˜­ç¸£":0};
const demoTraffic  = {"å˜‰ç¾©ç¸£":1,"èŠ±è“®ç¸£":0,"å—æŠ•ç¸£":0,"è‡ºå—å¸‚":0,"è‡ºæ±ç¸£":0,"æ–°åŒ—å¸‚":1,"é«˜é›„å¸‚":1,"æ¾æ¹–ç¸£":0,"é€£æ±Ÿç¸£":0,"é›²æ—ç¸£":1,"é‡‘é–€ç¸£":0,"å®œè˜­ç¸£":1};

/* ========= çœŸå¯¦æŠ“å–ï¼šCWBï¼ˆF-C0032-001ï¼‰ =========
   å–å¾—ï¼šMinT, MaxT, PoP12hï¼›UV CWB æ²’æœ‰ç¸£å¸‚å³æ™‚å€¼ â†’ ä»¥ 6 ç•¶ä¿åº•
================================================ */
async function fetchCWBByCounty(county){
  if(!CWB_TOKEN) throw new Error('No CWB token');
  const url = `https://opendata.cwa.gov.tw/api/v1/rest/datastore/F-C0032-001?Authorization=${CWB_TOKEN}&locationName=${encodeURIComponent(county)}`;
  const r = await fetch(url);
  if(!r.ok) throw new Error('CWB HTTP '+r.status);
  const j = await r.json();
  const loc = j.records?.location?.[0];
  if(!loc) throw new Error('CWB empty');
  const el = Object.fromEntries(loc.weatherElement.map(e=>[e.elementName,e.time?.[0]?.parameter]));
  const minT = Number(el.MinT?.parameterName ?? 23);
  const maxT = Number(el.MaxT?.parameterName ?? 25);
  const pop  = Number(el.PoP?.parameterName ?? 20);
  const temp = Math.round((minT+maxT)/2);
  const uv = 6; // å…ˆä¿åº•ï¼ˆè‹¥ä½ æƒ³ä¸² UV APIï¼Œå¯å†è£œ O-A0005-001 ç«™é»è¿‘ä¼¼ï¼‰
  return {temp,pop,uv};
}

/* ========= çœŸå¯¦æŠ“å–ï¼šMoENV AQIï¼ˆaqx_p_432ï¼‰ =========
   èšåˆç¸£å¸‚å¹³å‡ AQI
==================================================== */
async function fetchAQIByCounty(){
  // æœ‰ API key å°±å¸¶ä¸Šï¼Œæ²’æœ‰ä¹Ÿå˜—è©¦åŒ¿åï¼ˆå®˜æ–¹å¶çˆ¾å…è¨±ï¼‰
  const base = 'https://data.moenv.gov.tw/api/v2/aqx_p_432';
  const q = `?format=json&limit=1000${MOENV_API_KEY ? '&api_key='+MOENV_API_KEY : ''}`;
  const r = await fetch(base+q);
  if(!r.ok) throw new Error('AQI HTTP '+r.status);
  const j = await r.json();
  const map = {};
  j.records.forEach(rec=>{
    const county = rec.county;
    const aqi = Number(rec.aqi);
    if(!county || !aqi) return;
    if(!map[county]) map[county]=[];
    map[county].push(aqi);
  });
  const avg = {};
  Object.keys(map).forEach(k=>{
    const arr = map[k];
    avg[k] = Math.round(arr.reduce((a,b)=>a+b,0)/arr.length);
  });
  return avg; // {ç¸£å¸‚: å¹³å‡AQI}
}

/* ========= é¢¨éšª / äº¤é€šï¼ˆé ç•™ï¼›ç„¡ proxy å…ˆå›é€€ï¼‰ ========= */
async function fetchDisaster(){ return demoDisaster; }
async function fetchTraffic(){ return demoTraffic; }

/* ========= æ‰“åˆ†èˆ‡å»ºè­° ========= */
function baseScore({temp,pop,uv,aqi}){
  let s=75;
  s -= Math.min(10, Math.abs(temp-23));      // æº«åº¦è½å·®
  s -= (pop/100)*20;                         // é™é›¨
  s -= (aqi||50)*0.4;                        // AQIï¼ˆèª¿å’Œï¼‰
  if(uv>=9) s-=3; else if(uv>=7) s-=2; else if(uv>=6) s-=1;
  return Math.max(0,Math.min(95,Math.round(s)));
}
function locationAdjust(spotRegion,userCity){
  if(!document.getElementById('useGeo').checked) return 0;
  if(spotRegion.includes(userCity) || userCity.includes(spotRegion)) return +5;
  // é„°è¿‘å€ç°¡åŒ–
  const near = [
    ["è‡ºåŒ—å¸‚","æ–°åŒ—å¸‚","åŸºéš†å¸‚","å®œè˜­ç¸£"],["æ¡ƒåœ’å¸‚","æ–°ç«¹ç¸£","æ–°ç«¹å¸‚"],
    ["è‡ºä¸­å¸‚","è‹—æ —ç¸£","å—æŠ•ç¸£","å½°åŒ–ç¸£"],["è‡ºå—å¸‚","é«˜é›„å¸‚","é›²æ—ç¸£","å˜‰ç¾©ç¸£"],
  ];
  const g = near.find(a=>a.includes(userCity));
  if(g && g.some(x=>spotRegion.includes(x))) return +2;
  return 0;
}
function riskPenalty(spotRegion,disaster,traffic){
  const d = disaster[spotRegion] ?? 0;
  const t = traffic[spotRegion] ?? 0;
  const pd = d===2?-15: d===1?-5: 0;
  const pt = t===2?-8:  t===1?-3: 0;
  return pd+pt;
}
function colorOf(score){
  if(score>=90) return {cls:"green",text:"éå¸¸é©åˆå‡ºéŠ",emoji:"ğŸŸ¢"};
  if(score>=75) return {cls:"blue", text:"é©åˆå‡ºéŠ",  emoji:"ğŸ”µ"};
  if(score>=60) return {cls:"amber",text:"å°šå¯å‡ºéŠ",  emoji:"ğŸŸ¡"};
  return {cls:"red", text:"å»ºè­°æ”¹æœŸ",  emoji:"ğŸ”´"};
}
function oneLineAdvice({temp,pop,uv,aqi},score){
  if(score<60) return "å¤©æ°£/èƒ½è¦‹åº¦æˆ–é™é›¨é¢¨éšªåé«˜ï¼Œå»ºè­°æ”¹æœŸã€‚";
  if(pop>=50)  return "é™é›¨æ©Ÿç‡åé«˜ï¼Œè¨˜å¾—é›¨å…·ä¸¦ç•™æ„è·¯æ³ã€‚";
  if(aqi>=80)  return "ç©ºå“è¼ƒå·®ï¼Œå»ºè­°å£ç½©ï¼›æ”¹å®¤å…§æˆ–ä½å¼·åº¦è¡Œç¨‹ã€‚";
  if(uv>=8)    return "ç´«å¤–ç·šå¾ˆå¼·ï¼Œé˜²æ›¬è£œæ°´èˆ‡é®é™½ä¸å¯å°‘ã€‚";
  if(Math.abs(temp-23)>=6) return "æº«å·®è¼ƒå¤§ï¼Œè«‹å‚™å¦¥ä¿æš–/é™æº«ç”¨å“ã€‚";
  return "æ¢ä»¶ä¸éŒ¯ï¼Œå»ºè­°æŠŠæ¡æ™‚é–“ã€é¿é–‹å°–å³°è»Šæ½®ã€‚";
}

/* ========= UI è¡Œç‚º ========= */
function openMapAt(lat,lng){
  const ua=navigator.userAgent.toLowerCase();
  const apple=`http://maps.apple.com/?ll=${lat},${lng}`;
  const google=`https://maps.google.com/?q=${lat},${lng}`;
  if(/iphone|ipad|macintosh/.test(ua)) window.open(apple,'_blank'); else window.open(google,'_blank');
}
function navTo(lat,lng){
  const ua=navigator.userAgent.toLowerCase();
  const apple=`http://maps.apple.com/?daddr=${lat},${lng}`;
  const google=`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
  if(/iphone|ipad|macintosh/.test(ua)) window.open(apple,'_blank'); else window.open(google,'_blank');
}

/* ========= ä¸»æµç¨‹ï¼šæŠ“å– â†’ åˆæˆ â†’ ç¹ªè£½ ========= */
async function loadAndRender(){
  const badgeCWB = document.getElementById('badgeCWB');
  const badgeAQI = document.getElementById('badgeAQI');
  const userCity = selCity.value;

  // 1) AQIï¼ˆä¸€æ¬¡æŠ“æ‰€æœ‰ç¸£å¸‚ï¼Œé¿å…å¤šé€£ç·šï¼‰
  let aqiMap;
  try{
    aqiMap = await fetchAQIByCounty();
    badgeAQI.textContent = "MoENVï¼šAQIï¼ˆé€£ç·šæˆåŠŸï¼‰";
  }catch(e){
    aqiMap = {};
    badgeAQI.textContent = "MoENVï¼šAQIï¼ˆå›é€€å±•ç¤ºå€¼ï¼‰";
  }

  // 2) ç½å®³ï¼†äº¤é€šï¼ˆç„¡ proxy å…ˆå›é€€ï¼‰
  const disaster = await fetchDisaster();
  const traffic  = await fetchTraffic();

  const container = document.getElementById('cards');
  container.innerHTML = '';

  // 3) é€é¢¨æ™¯å€ç”¢ç”Ÿå¡ç‰‡ï¼ˆæ¯å¼µå¡ç‰‡è¦æº«åº¦/é™é›¨ï¼Œæ‰€ä»¥æ‰é€ç¸£å¸‚æ‰“ CWBï¼›è‹¥è¦æ¸›å°‘è«‹æ”¹æˆå¿«å–ï¼‰
  for(const sp of spots){
    let met;
    try{
      if(CWB_TOKEN){
        const cw = await fetchCWBByCounty(sp.region);
        met = { ...cw, aqi: aqiMap[sp.region] ?? (demoWeather[sp.region]?.aqi ?? 50) };
        badgeCWB.textContent = "CWBï¼šå¤©æ°£ï¼ˆé€£ç·šæˆåŠŸï¼‰";
      }else{
        throw new Error('no token');
      }
    }catch(e){
      met = demoWeather[sp.region] || {temp:24,pop:20,uv:6,aqi: aqiMap[sp.region]??50};
      badgeCWB.textContent = "CWBï¼šå¤©æ°£ï¼ˆå›é€€å±•ç¤ºå€¼ï¼‰";
    }

    // 4) æ‰“åˆ†ï¼‹å»ºè­°
    const s0 = baseScore(met);
    const adj = locationAdjust(sp.region, userCity);
    const pen = riskPenalty(sp.region, disaster, traffic);
    const score = Math.max(0,Math.min(100, s0+adj+pen));
    const led = colorOf(score);
    const tip = oneLineAdvice(met, score);

    // 5) å¡ç‰‡
    const card=document.createElement('div');
    card.className='card';
    card.innerHTML = `
      <div class="title">
        <div>
          <h3>${sp.name}</h3>
          <div class="meta">${sp.region}</div>
        </div>
        <div style="text-align:right">
          <div class="badge ${led.cls}">${led.emoji} åˆ†æ•¸ ${score}</div>
          <div class="meta" style="max-width:260px">${tip}</div>
        </div>
      </div>
      <div class="metrics">
        <div class="pill">ğŸŒ¡ï¸ ${met.temp}Â°C</div>
        <div class="pill">ğŸŒ§ï¸ ${met.pop}%</div>
        <div class="pill">â˜€ï¸ UV ${met.uv}</div>
        <div class="pill">ğŸ«§ AQI ${met.aqi ?? 'â€”'}</div>
      </div>
      <div class="acts">
        <button class="actBtn" data-act="pin">ğŸ“ ä¸€éµåˆ°é»</button>
        <button class="actBtn" data-act="nav">ğŸ—ºï¸ åœ°åœ–å°èˆª</button>
        <a class="actBtn" href="${sp.url}" target="_blank" rel="noopener">ğŸ“„ å®˜æ–¹ç¶²ç«™</a>
      </div>
    `;
    card.querySelector('[data-act="pin"]').onclick = ()=>openMapAt(sp.lat,sp.lng);
    card.querySelector('[data-act="nav"]').onclick = ()=>navTo(sp.lat,sp.lng);
    container.appendChild(card);
  }

  // æ›´æ–°æ™‚é–“
  const t=new Date(), pad=n=>n.toString().padStart(2,'0');
  document.getElementById('txtTime').textContent =
    `ğŸ•’ æ›´æ–°æ™‚é–“ï¼š${t.getFullYear()}-${pad(t.getMonth()+1)}-${pad(t.getDate())} ${pad(t.getHours())}:${pad(t.getMinutes())}`;
}

document.getElementById('btnRefresh').addEventListener('click', loadAndRender);
document.getElementById('useGeo').addEventListener('change', loadAndRender);
selCity.addEventListener('change', loadAndRender);

// é¦–æ¬¡è¼‰å…¥
loadAndRender();
</script>
</body>
</html>
