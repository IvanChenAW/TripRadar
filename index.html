<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>TripRadarï½œå»ºè­°æ—…éŠåˆ†æ•¸ï¼ˆv5.5 å±•ç¤ºç‰ˆï¼‰</title>
<meta name="theme-color" content="#246BFD"/>
<style>
:root{
  --ink:#0d1b2a; --muted:#5b6b7a; --bg:#f7f9fc;
  --card:#ffffff; --primary:#246BFD; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444; --blue:#2563eb;
  --shadow:0 8px 24px rgba(13,27,42,.08);
  --radius:18px;
}
*{box-sizing:border-box}
body{
  margin:0; font-family:"Noto Sans TC","PingFang TC",system-ui,-apple-system;
  color:var(--ink); background:var(--bg);
}
header{
  background:linear-gradient(180deg,#2d6dfd,#5aa2ff);
  color:#fff; padding:24px 20px 16px; position:sticky; top:0; z-index:20;
  box-shadow:0 6px 16px rgba(0,0,0,.08);
}
.brand{font-size:28px;font-weight:800;}
.sub{opacity:.95;margin-top:4px}
.toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
.pill{
  background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.3);color:#fff;
  padding:10px 14px;border-radius:12px;backdrop-filter:blur(6px);font-weight:600;
}
.btn{
  background:#fff;color:var(--primary);border:0;padding:10px 14px;border-radius:12px;font-weight:700;
  box-shadow:var(--shadow);cursor:pointer;
}
main{padding:18px}
.filterbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:14px}
.chk{display:flex;align-items:center;gap:10px;background:var(--card);padding:12px 14px;border-radius:12px;box-shadow:var(--shadow)}
select{border:1px solid #e5e7eb;border-radius:10px;padding:10px 12px;background:#fff;box-shadow:var(--shadow);font-weight:700}
.riskbar{display:none;align-items:center;gap:12px;background:#fff4e5;color:#8a3b00;border:1px solid #ffd9a8;
padding:10px 12px;border-radius:12px;margin-bottom:14px;box-shadow:var(--shadow);}
.grid{display:grid;grid-template-columns:1fr;gap:16px}
@media(min-width:760px){.grid{grid-template-columns:1fr 1fr}}
@media(min-width:1080px){.grid{grid-template-columns:1fr 1fr 1fr}}
.card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column;}
.card-hd{padding:18px 18px 0}
.place{font-size:22px;font-weight:900}
.county{color:var(--muted);margin-top:6px}
.score-badge{margin-top:10px;display:inline-flex;align-items:center;gap:8px;font-weight:900;color:#fff;
padding:8px 14px;border-radius:999px;}
.s-green{background:linear-gradient(135deg,#22c55e,#10b981)}
.s-blue{background:linear-gradient(135deg,#60a5fa,#2563eb)}
.s-amber{background:linear-gradient(135deg,#fbbf24,#f59e0b)}
.s-red{background:linear-gradient(135deg,#f87171,#ef4444)}
.risk-chip{margin-left:8px;display:inline-flex;align-items:center;gap:6px;background:#fff0ef;color:#b42318;border:1px solid #ffc7c2;padding:6px 10px;border-radius:999px;font-weight:700}
.indics{display:flex;gap:10px;padding:14px 18px 6px;flex-wrap:wrap}
.chip{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;background:#eef2ff;color:#1f2a44;font-weight:800;border:1px solid #e6e9ff;}
.ops{display:flex;gap:10px;padding:12px 18px 18px;flex-wrap:wrap}
.action{flex:1 1 140px;display:flex;align-items:center;justify-content:center;gap:8px;padding:12px;border-radius:12px;
border:1px solid #e5e7eb;background:#fff;font-weight:800;cursor:pointer;}
.src{padding:10px 18px 18px;color:var(--muted)}
.src .btns{display:flex;gap:10px;flex-wrap:wrap}
.tag{background:#eef2ff;border:1px solid #dbe1ff;color:#223;padding:8px 10px;border-radius:10px;font-weight:700}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:flex-end;z-index:40}
.sheet{background:#fff;width:100%;border-radius:16px 16px 0 0;padding:16px;max-height:80vh;overflow:auto}
.sheet h3{margin:4px 0 10px}
.step{display:flex;gap:10px;align-items:flex-start;padding:8px 0;border-bottom:1px dashed #eee}
.step:last-child{border-bottom:0}
.step .k{font-weight:900;color:var(--primary);width:22px}
.close{position:absolute;right:16px;top:10px;background:#eee;border:0;padding:6px 10px;border-radius:8px;cursor:pointer}
.muted{color:var(--muted)}
</style>
</head>
<body>
<header>
  <div class="brand">TripRadar</div>
  <div class="sub">è¡Œå‰ 1 åˆ†é˜ï½œå»ºè­°æ—…éŠåˆ†æ•¸ + äº¤é€šèˆ‡ç½å®³é¢¨éšª</div>
  <div class="toolbar">
    <div class="pill" id="ts">æ›´æ–°æ™‚é–“ï¼šâ€”</div>
    <button class="btn" id="btnReload">é‡æ–°æŠ“å–</button>
  </div>
</header>

<main>
  <div id="riskBar" class="riskbar">âš ï¸ é¢¨éšªå…ˆçŸ¥ï¼šâ€”</div>

  <div class="filterbar">
    <label class="chk"><input type="checkbox" id="useLoc" checked/><b>ä½¿ç”¨æ‰€åœ¨å€åŠ æ¬Š</b></label>
    <label class="chk"><b>æ‰‹å‹•æ‰€åœ¨å€ï¼š</b>
      <select id="citySel">
        <option>è‡ºåŒ—å¸‚</option><option>æ–°åŒ—å¸‚</option><option>æ¡ƒåœ’å¸‚</option>
        <option>æ–°ç«¹å¸‚</option><option>è‡ºä¸­å¸‚</option><option>å—æŠ•ç¸£</option>
        <option>å˜‰ç¾©ç¸£</option><option>èŠ±è“®ç¸£</option><option>é«˜é›„å¸‚</option>
        <option>å±æ±ç¸£</option><option>å®œè˜­ç¸£</option><option>æ¾æ¹–ç¸£</option>
        <option>é‡‘é–€ç¸£</option><option>é€£æ±Ÿç¸£</option>
      </select>
    </label>
  </div>

  <div id="cards" class="grid"></div>

  <div class="src">
    <div class="muted" style="margin-bottom:8px;">è³‡æ–™ä¾†æºï¼ˆå±•ç¤ºç‰ˆæœ¬ï¼Œå·²å¿«å–ï¼æ¨¡æ“¬ï¼‰ï¼š</div>
    <div class="btns">
      <span class="tag">CWBï¼šå¤©æ°£</span>
      <span class="tag">MoENVï¼šAQI</span>
      <span class="tag">NCDRï¼šç½å®³CAP</span>
      <span class="tag">TDXï¼šè½‰ä¹˜/è·¯æ³</span>
    </div>
  </div>
</main>

<div id="modal" class="modal-backdrop">
  <div class="sheet">
    <button class="close" id="closeSheet">é—œé–‰ Ã—</button>
    <h3 id="sheetTitle">â€”</h3>
    <div id="sheetBody"></div>
  </div>
</div>

<script>
// -------- åŸºæœ¬è³‡æ–™ --------
const SPOTS=[
{id:"alishan",name:"é˜¿é‡Œå±±",county:"å˜‰ç¾©ç¸£",lat:23.5,lng:120.8,web:"https://www.tbocc.gov.tw/"},
{id:"taroko",name:"å¤ªé­¯é–£",county:"èŠ±è“®ç¸£",lat:24.16,lng:121.62,web:"https://www.taroko.gov.tw/"},
{id:"sunmoon",name:"æ—¥æœˆæ½­",county:"å—æŠ•ç¸£",lat:23.86,lng:120.91,web:"https://www.sunmoonlake.gov.tw/"},
{id:"kenting",name:"å¢¾ä¸åœ‹å®¶å…¬åœ’",county:"å±æ±ç¸£",lat:21.94,lng:120.78,web:"https://www.ktnp.gov.tw/"},
{id:"penghu",name:"æ¾æ¹–ç£",county:"æ¾æ¹–ç¸£",lat:23.57,lng:119.57,web:"https://www.penghu-nsa.gov.tw/"},
{id:"yushan",name:"ç‰å±±",county:"å—æŠ•ç¸£",lat:23.47,lng:120.95,web:"https://www.ysnp.gov.tw/"}
];

const CAP_ALERTS=[
 {county:"èŠ±è“®ç¸£",type:"é›·æš´",level:"æ©™è‰²",time:"2025/10/30 09:30"},
 {county:"å—æŠ•ç¸£",type:"è±ªé›¨",level:"æ©™è‰²",time:"2025/10/30 10:00"}
];

const TRAFFIC_MOCK={
 alishan:{factor:1.5,summary:"çœé“18ç·šå±±å€è»Šå¤šï¼Œå½é“æ¸›é€Ÿ"},
 taroko:{factor:1.2,summary:"å°8ç·šå±€éƒ¨æ–½å·¥æ”¹é“"},
 sunmoon:{factor:1.0,summary:"è·¯æ³é †æš¢"}
};

const GEO_MOCK={
 taroko:{level:"orange",note:"ä¸­æ©«å±€éƒ¨è½çŸ³é¢¨éšªå¢é«˜"},
 alishan:{level:"yellow",note:"é€£æ—¥é™é›¨å¾Œå±±å€åœŸçŸ³æ˜“é¬†å‹•"}
};

const DEMO={baseTemp:24,basePop:20,baseAqi:45,baseUv:6};

// -------- åŠ æ¬Šå…¬å¼ --------
function scoreOf({t,pop,aqi,uv}){
 let tempScore=100-Math.abs(23-t)*6;
 let rainScore=100-pop;
 let aqiScore=Math.max(0,100-aqi*0.8);
 let uvScore=70;
 return Math.round((tempScore*0.25+rainScore*0.35+aqiScore*0.25+uvScore*0.15));
}
function trafficPenalty(f){return Math.max(-15,Math.min(0,-15*(f-1)));}
function geoPenalty(lv){if(lv==="orange")return -15;if(lv==="yellow")return -8;return 0;}
function colorClass(s){if(s>=90)return"s-green";if(s>=75)return"s-blue";if(s>=60)return"s-amber";return"s-red";}
function textByScore(s){if(s>=90)return"éå¸¸é©åˆå‡ºéŠ";if(s>=75)return"é©åˆå‡ºéŠ";if(s>=60)return"å°šå¯å‡ºéŠ";return"å»ºè­°æ”¹æœŸ";}
function fmt(n){return Number(n).toFixed(0);}

// -------- ç•«é¢èˆ‡äº’å‹• --------
const elCards=document.getElementById("cards");
const elCity=document.getElementById("citySel");
const elUseLoc=document.getElementById("useLoc");
const elTs=document.getElementById("ts");
const riskBar=document.getElementById("riskBar");
const modal=document.getElementById("modal");
const sheetT=document.getElementById("sheetTitle");
const sheetB=document.getElementById("sheetBody");
document.getElementById("closeSheet").onclick=()=>modal.style.display="none";
modal.addEventListener("click",e=>{if(e.target===modal)modal.style.display="none";});
function nowTS(){
 const d=new Date();
 elTs.textContent=`æ›´æ–°æ™‚é–“ï¼š${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,"0")}`;
}

function render(){
 nowTS();elCards.innerHTML="";
 const where=elCity.value;
 const hits=CAP_ALERTS.filter(a=>a.county===where);
 if(hits.length){riskBar.style.display="flex";riskBar.textContent=`âš ï¸ é¢¨éšªå…ˆçŸ¥ï¼š${hits.map(a=>a.county+" "+a.type+"("+a.level+")").join("ã€")} â€” ${hits[0].time}`;}
 else{riskBar.style.display="none";}

 SPOTS.forEach((p,i)=>{
   const t=DEMO.baseTemp+(i%3-1);
   const pop=DEMO.basePop+(i%4)*5;
   const aqi=DEMO.baseAqi+(i%5)*3;
   const uv=DEMO.baseUv;
   let s=scoreOf({t,pop,aqi,uv});

   if(elUseLoc.checked){
     if(p.county===where)s=Math.min(100,s+5);
     const island=["æ¾æ¹–ç¸£","é‡‘é–€ç¸£","é€£æ±Ÿç¸£"];
     if(island.includes(p.county)&&!island.includes(where))s=Math.max(0,s-5);
   }
   const cap=CAP_ALERTS.find(a=>a.county===p.county);
   if(cap){s+=cap.level==="æ©™è‰²"?-10:cap.level==="é»ƒè‰²"?-5:0;}

   const tf=(TRAFFIC_MOCK[p.id]?.factor??1.0);
   s+=trafficPenalty(tf);
   const geoLv=GEO_MOCK[p.id]?.level??"none";
   s+=geoPenalty(geoLv);
   s=Math.max(0,Math.min(100,Math.round(s)));

   const capChip=cap?`<span class="risk-chip">âš ï¸${cap.type}(${cap.level})</span>`:"";
   const trafficChip=tf>1.05?`<span class="risk-chip">ğŸš§å£…å¡x${tf.toFixed(2)}</span>`:"";
   const geoChip=geoLv!=="none"?`<span class="risk-chip">ğŸª¨${geoLv==="orange"?"åœŸçŸ³æµ(æ©™)":"åœ°ç½(é»ƒ)"}</span>`:"";

   const card=document.createElement("section");card.className="card";
   card.innerHTML=`
     <div class="card-hd">
       <div class="place">${p.name}</div>
       <div class="county">${p.county}</div>
       <div><span class="score-badge ${colorClass(s)}">å»ºè­°æ—…éŠåˆ†æ•¸ ${s}</span>${capChip}${trafficChip}${geoChip}</div>
     </div>
     <div class="indics">
       <span class="chip">ğŸŒ¡ï¸${fmt(t)}Â°C</span>
       <span class="chip">ğŸŒ§ï¸${fmt(pop)}%</span>
       <span class="chip">ğŸ«§AQI ${fmt(aqi)}</span>
     </div>
     <div class="ops">
       <button class="action" onclick="openMap(${p.lat},${p.lng})">ğŸ“ä¸€éµåˆ°é»</button>
       <button class="action" onclick="window.open('https://maps.google.com/?q=${p.lat},${p.lng}')">ğŸ—ºï¸åœ°åœ–å°èˆª</button>
       <button class="action" onclick="showTransit('${p.id}','${p.name}')">ğŸš†è½‰ä¹˜å»ºè­°</button>
       <button class="action" onclick="showSnap('${p.id}','${p.name}')">ğŸ›°ï¸è·¯æ³å¿«ç…§</button>
       <button class="action" onclick="window.open('${p.web}')">ğŸ›ï¸æ™¯å€å®˜ç¶²</button>
     </div>
     <div class="src muted">ä¸€å¥å»ºè­°ï¼š${textByScore(s)}ã€‚</div>`;
   elCards.appendChild(card);
 });
}

function openMap(lat,lng){
 const ua=navigator.userAgent.toLowerCase();
 const isApple=/iphone|ipad|macintosh/.test(ua);
 window.open(isApple?`http://maps.apple.com/?ll=${lat},${lng}`:`https://maps.google.com/?q=${lat},${lng}`,"_blank");
}
function showTransit(id,name){
 sheetT.textContent=`${name}ï½œè½‰ä¹˜å»ºè­°ï¼ˆæ¨¡æ“¬ï¼‰`;
 sheetB.innerHTML=`<div class="step"><div class="k">1</div><div>ä¸»è¦åŸå¸‚æ­ä¹˜å¤§çœ¾é‹è¼¸è‡³æ™¯å€é–€å£</div></div>
 <div class="step"><div class="k">2</div><div>æ­¥è¡Œ 5â€“10 åˆ†ï¼Œæ³¨æ„æœ«ç­æ™‚é–“</div></div>`;
 modal.style.display="flex";
}
function showSnap(id,name){
 const tf=(TRAFFIC_MOCK[id]?.factor??1.0);
 const geo=GEO_MOCK[id];
 const free=60,eta=Math.round(free*tf);
 sheetT.textContent=`${name}ï½œè·¯æ³å¿«ç…§`;
 sheetB.innerHTML=`
