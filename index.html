<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>TripRadarï½œApp ä»‹é¢ï¼ˆv5.2ï¼‰</title>
  <meta name="description" content="è¡Œå‰1åˆ†é˜ï¼Œä¸€çœ¼çœ‹å‡ºæ—…éŠèˆ’é©åº¦ | TripRadar DEMO" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --ink:#0d1b2a;
      --muted:#5b6b7a;
      --card:#ffffff;
      --bg:#f6f8fb;
      --brand:#2d6cdf;
      --chip:#eef2ff;
      --chip-ink:#1f2a44;

      /* score colors */
      --green:#22c55e;
      --blue:#3b82f6;
      --amber:#f59e0b;
      --red:#ef4444;

      --shadow:0 10px 30px rgba(13,27,42,.06);
      --radius:18px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Noto Sans TC",system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue","PingFang TC","Microsoft JhengHei",sans-serif;
      color:var(--ink);
      background:var(--bg);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    .appbar{
      position:sticky;top:0;z-index:30;
      display:flex;align-items:center;justify-content:space-between;
      gap:12px;padding:14px 18px;
      background:linear-gradient(180deg,#0f172a 0%, #1e293b 60%, #233146 100%);
      color:#fff;
      box-shadow:var(--shadow);
    }
    .brand{font-size:22px;font-weight:800;letter-spacing:.5px}
    .sub{opacity:.8;font-size:13px}

    .container{max-width:980px;margin:22px auto;padding:0 14px}
    .toolbar{
      display:flex;flex-wrap:wrap;gap:12px;align-items:center;
      padding:14px;background:#fff;border-radius:16px;box-shadow:var(--shadow)
    }
    .select,.switch,.btn-refresh{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 14px;border-radius:12px;border:1px solid #e6ecf5;background:#fff;
      color:var(--ink);font-weight:500
    }
    .btn-refresh{background:var(--brand);border-color:transparent;color:#fff}
    .note{margin-left:auto;color:var(--muted);font-size:13px}

    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;margin-top:16px}
    .card{
      background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px 16px 12px
    }
    .card h3{margin:0 0 10px 0;font-size:20px}
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 12px;border-radius:999px;color:#fff;font-weight:700;font-size:14px
    }
    .score-green{background:var(--green)}
    .score-blue{background:var(--blue)}
    .score-amber{background:var(--amber)}
    .score-red{background:var(--red)}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin:12px 0}
    .chip{
      background:var(--chip);color:var(--chip-ink);border-radius:999px;
      padding:8px 12px;font-size:14px;font-weight:600;display:inline-flex;align-items:center;gap:6px
    }
    .actions{display:flex;gap:10px;margin-top:10px}
    .btn{
      flex:1 1 auto;display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:12px;border-radius:12px;border:1px solid #e6ecf5;background:#fff;font-weight:700
    }
    .btn .emo{font-size:18px}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:#2563eb;color:#fff;border-color:transparent}

    .legend{display:flex;flex-wrap:wrap;gap:16px;align-items:center;margin-top:16px;color:var(--muted)}
    .dot{display:inline-flex;align-items:center;gap:8px}
    .dot i{width:10px;height:10px;border-radius:50%}
    .green i{background:var(--green)} .blue i{background:var(--blue)} .amber i{background:var(--amber)} .red i{background:var(--red)}

    footer{
      margin:26px auto 40px;max-width:980px;padding:0 14px;color:var(--muted);font-size:13px
    }
    .small{opacity:.9}
    .src a{color:var(--brand);text-decoration:none}
  </style>
</head>
<body>
  <header class="appbar">
    <div>
      <div class="brand">TripRadar</div>
      <div class="sub">è¡Œå‰ 1 åˆ†é˜ï¼Œä¸€çœ¼çœ‹å‡ºæ—…éŠèˆ’é©åº¦</div>
    </div>
    <div class="sub" id="lastUpdate">æ›´æ–°æ™‚é–“ï¼šâ€”</div>
  </header>

  <main class="container">
    <div class="toolbar">
      <label class="switch"><input id="useGeo" type="checkbox" checked> ä½¿ç”¨æ‰€åœ¨å€åŠ æ¬Š</label>
      <label class="select">æ‰‹å‹•æ‰€åœ¨åœ°ï¼š
        <select id="city">
          <option value="è‡ºåŒ—å¸‚">è‡ºåŒ—å¸‚</option>
          <option value="æ–°åŒ—å¸‚">æ–°åŒ—å¸‚</option>
          <option value="æ¡ƒåœ’å¸‚">æ¡ƒåœ’å¸‚</option>
          <option value="æ–°ç«¹å¸‚">æ–°ç«¹å¸‚</option>
          <option value="è‡ºä¸­å¸‚">è‡ºä¸­å¸‚</option>
          <option value="è‡ºå—å¸‚">è‡ºå—å¸‚</option>
          <option value="é«˜é›„å¸‚">é«˜é›„å¸‚</option>
        </select>
      </label>
      <button class="btn-refresh" id="btnReload">é‡æ–°æŠ“å–</button>
      <div class="note">ç‹€æ…‹ï¼š<span id="status">å¿«å–</span></div>
    </div>

    <div class="legend">
      <span class="dot green"><i></i> â‰¥90 éå¸¸é©åˆå‡ºéŠ</span>
      <span class="dot blue"><i></i> 75â€“89 é©åˆå‡ºéŠ</span>
      <span class="dot amber"><i></i> 60â€“74 å°šå¯å‡ºéŠ</span>
      <span class="dot red"><i></i> &lt;60 å»ºè­°æ”¹æœŸ</span>
    </div>

    <section class="grid" id="grid"></section>
  </main>

  <footer>
    <div class="small src">
      Â© 2025 TripRadarï¼ˆDEMOï¼‰ï¼è³‡æ–™ä¾†æºï¼š
      <a href="https://opendata.cwa.gov.tw/" target="_blank" rel="noopener">æ°£è±¡ç½² CWB</a>ã€
      <a href="https://data.moenv.gov.tw/" target="_blank" rel="noopener">ç’°å¢ƒéƒ¨ OpenData</a>ã€‚
      è‹¥ç¶²è·¯ä¸ç©©ï¼Œç³»çµ±æœƒä»¥å¿«å–ç¤ºæ„å‘ˆç¾ã€‚
    </div>
  </footer>

  <script>
  /* ========== å¯é¸ï¼šè‹¥è¦é€£ OpenDataï¼ŒæŠŠ API KEY å¡«åœ¨é€™è£¡ ========== */
  const CWB_API_KEY = "";     // ä¾‹ï¼š "CWA-XXXX"
  const MOENV_AQI_KEY = "";   // è‹¥éœ€è¦
  /* =========================================================== */

  // æ˜¯å¦å˜—è©¦é€£ OpenData
  const USE_OPENAPI = /[?&]openapi=1/.test(location.search) && (CWB_API_KEY || MOENV_AQI_KEY);

  // å®˜æ–¹ç¶²ç«™å°ç…§è¡¨ï¼ˆå¯è‡ªè¡Œæ›´æ–°ï¼‰
  const SPOT_URL = {
    "é˜¿é‡Œå±±":"https://www.alishan-nsa.gov.tw",
    "å¤ªé­¯é–£":"https://www.taroko.gov.tw",
    "æ—¥æœˆæ½­":"https://www.sunmoonlake.gov.tw",
    "è¥¿æ‹‰é›…":"https://www.siraya-nsa.gov.tw",
    "é¦¬ç¥–":"https://www.matsu-nsa.gov.tw",
    "æ¾æ¹–":"https://www.penghu-nsa.gov.tw",
    "æ±éƒ¨æµ·å²¸":"https://www.eastcoast-nsa.gov.tw",
    "èŠ±æ±ç¸±è°·":"https://www.erv-nsa.gov.tw",
    "é‡‘é–€":"https://www.kinmen-nsa.gov.tw",
    "èŒ‚æ—":"https://www.maolin-nsa.gov.tw",
    "é›²å˜‰å—æ¿±æµ·":"https://www.swcoast-nsa.gov.tw",
    "åŒ—æµ·å²¸åŠè§€éŸ³å±±":"https://www.northguan-nsa.gov.tw",
    "æ±åŒ—è§’æš¨å®œè˜­æµ·å²¸":"https://www.necoast-nsa.gov.tw"
  };

  // 13 è™•é¢¨æ™¯å€ï¼ˆç¤ºæ„åº§æ¨™ + æ‰€å±¬ç¸£å¸‚ï¼‰
  const SPOTS = [
    {name:"é˜¿é‡Œå±±", city:"å˜‰ç¾©ç¸£", lat:23.5085, lng:120.795,  mock:{T:24, POP:20, UV:6, AQI:45}},
    {name:"å¤ªé­¯é–£", city:"èŠ±è“®ç¸£", lat:24.163,  lng:121.621,  mock:{T:22, POP:30, UV:6, AQI:35}},
    {name:"æ—¥æœˆæ½­", city:"å—æŠ•ç¸£", lat:23.865,  lng:120.915,  mock:{T:24, POP:20, UV:6, AQI:45}},
    {name:"è¥¿æ‹‰é›…", city:"è‡ºå—å¸‚", lat:23.114,  lng:120.319,  mock:{T:26, POP:10, UV:7, AQI:55}},
    {name:"é¦¬ç¥–",   city:"é€£æ±Ÿç¸£", lat:26.161,  lng:119.949,  mock:{T:22, POP:30, UV:6, AQI:40}},
    {name:"æ¾æ¹–",   city:"æ¾æ¹–ç¸£", lat:23.571,  lng:119.579,  mock:{T:25, POP:20, UV:7, AQI:50}},
    {name:"æ±éƒ¨æµ·å²¸",city:"è‡ºæ±ç¸£", lat:22.947,  lng:121.163,  mock:{T:27, POP:10, UV:8, AQI:35}},
    {name:"èŠ±æ±ç¸±è°·",city:"èŠ±è“®ç¸£", lat:23.6,    lng:121.38,   mock:{T:26, POP:20, UV:7, AQI:40}},
    {name:"é‡‘é–€",   city:"é‡‘é–€ç¸£", lat:24.436,  lng:118.318,  mock:{T:23, POP:20, UV:6, AQI:45}},
    {name:"èŒ‚æ—",   city:"é«˜é›„å¸‚", lat:22.89,   lng:120.68,   mock:{T:27, POP:20, UV:7, AQI:55}},
    {name:"é›²å˜‰å—æ¿±æµ·", city:"é›²æ—ç¸£",lat:23.707, lng:120.180,  mock:{T:25, POP:20, UV:7, AQI:60}},
    {name:"åŒ—æµ·å²¸åŠè§€éŸ³å±±",city:"æ–°åŒ—å¸‚",lat:25.287,lng:121.568, mock:{T:23, POP:30, UV:6, AQI:40}},
    {name:"æ±åŒ—è§’æš¨å®œè˜­æµ·å²¸",city:"å®œè˜­ç¸£",lat:24.971,lng:121.917, mock:{T:24, POP:20, UV:6, AQI:45}}
  ];

  // æ—…éŠåˆ†æ•¸ï¼ˆç°¡åŒ–ç‰ˆæ¼”ç®—æ³•ï¼šBase 75ï¼Œä¾æŒ‡æ¨™å¾®èª¿ï¼›ä¹‹å¾Œå¯æ›æˆå¯¦éš› OpenDataï¼‰
  function calcTripScore(m){
    // m: {T, POP, UV, AQI}
    let score = 75;
    // æº«åº¦ï¼šè¶¨è¿‘ 18~28 æœ€ä½³ï¼›è¶…å‡ºå€é–“æ¯ 1Â°C -1 åˆ†
    if(m.T!==undefined){
      if(m.T<18) score -= (18-m.T);
      if(m.T>28) score -= (m.T-28);
    }
    // é™é›¨æ©Ÿç‡ï¼šæ¯ +10% â†’ -5 åˆ†
    if(m.POP!==undefined) score -= Math.round((m.POP/10)*5*0.5); // ç¨å¾®æ”¾ç·©
    // AQIï¼šæ¯ +10 â†’ -2 åˆ†
    if(m.AQI!==undefined) score -= Math.round((m.AQI/10)*2);
    // UVï¼š>8 ç¨é™
    if(m.UV!==undefined && m.UV>8) score -= (m.UV-8)*2;

    // é™åˆ¶åœ¨ 0~100
    score = Math.max(0, Math.min(100, score));
    return Math.round(score);
  }

  // é¡è‰²ï¼šğŸ”µ75â€“89 è¦è—è‰²ï¼ˆä¿®æ­£ï¼‰
  function scoreClass(s){
    if(s>=90) return "score-green";
    if(s>=75) return "score-blue";
    if(s>=60) return "score-amber";
    return "score-red";
  }

  // å‹•ä½œï¼šä¸€éµåˆ°é»ï¼ˆåƒ…é–‹é»ä½ï¼‰
  function openMapAt(lat,lng,name){
    const ua = navigator.userAgent.toLowerCase();
    const isIOS = /iphone|ipad|ipod/.test(ua);
    const url = isIOS
      ? `http://maps.apple.com/?ll=${lat},${lng}&q=${encodeURIComponent(name||"ç›®çš„åœ°")}`
      : `https://maps.google.com/?q=${encodeURIComponent(name||"ç›®çš„åœ°")}@${lat},${lng}`;
    window.open(url,"_blank");
  }

  // å‹•ä½œï¼šåœ°åœ–å°èˆªï¼ˆç›´æ¥è·¯ç·šï¼‰
  function openNavTo(lat,lng){
    const ua = navigator.userAgent.toLowerCase();
    const isIOS = /iphone|ipad|ipod/.test(ua);
    const url = isIOS
      ? `http://maps.apple.com/?daddr=${lat},${lng}&dirflg=d`
      : `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=driving`;
    window.open(url,"_blank");
  }

  // ç”¢ç”Ÿå¡ç‰‡
  function createCard(spot){
    const s = spot.score;
    const cls = scoreClass(s);
    const el = document.createElement("article");
    el.className = "card";
    el.innerHTML = `
      <h3>${spot.name}</h3>
      <span class="badge ${cls}">å»ºè­°æ—…éŠåˆ†æ•¸ ${s}</span>
      <div class="chips">
        <span class="chip">ğŸŒ¡ï¸ T ${spot.T}Â°C</span>
        <span class="chip">ğŸŒ§ï¸ POP ${spot.POP}%</span>
        <span class="chip">â˜€ï¸ UV ${spot.UV}</span>
        <span class="chip">ğŸ«§ AQI ${spot.AQI}</span>
        <span class="chip">ğŸ“ ${spot.city}</span>
      </div>
      <div class="actions">
        <button class="btn" data-act="go" data-lat="${spot.lat}" data-lng="${spot.lng}" data-name="${spot.name}">
          <span class="emo">ğŸ“</span>ä¸€éµåˆ°é»
        </button>
        <button class="btn" data-act="nav" data-lat="${spot.lat}" data-lng="${spot.lng}" data-name="${spot.name}">
          <span class="emo">ğŸ—ºï¸</span>åœ°åœ–å°èˆª
        </button>
        <button class="btn" data-act="web" data-name="${spot.name}">
          <span class="emo">ğŸŒ</span>å®˜æ–¹ç¶²ç«™
        </button>
      </div>
    `;
    // äº‹ä»¶
    el.querySelectorAll(".actions .btn").forEach(b=>{
      b.addEventListener("click",()=>{
        const act = b.dataset.act;
        if(act==="go")  openMapAt(+b.dataset.lat,+b.dataset.lng,b.dataset.name);
        if(act==="nav") openNavTo(+b.dataset.lat,+b.dataset.lng);
        if(act==="web"){
          const url = SPOT_URL[b.dataset.name];
          if(url) window.open(url,"_blank");
          else alert("å°šæœªè¨­å®šå®˜æ–¹ç¶²ç«™ã€‚");
        }
      });
    });
    return el;
  }

  // ä¸»æµç¨‹ï¼šæŠ“è³‡æ–™ï¼ˆæ­¤ç‰ˆé è¨­ä½¿ç”¨ Mockï¼›åŠ  ?openapi=1 ä¸¦å¡« KEY å¾Œå¯æ“´å……ï¼‰
  async function loadData(){
    const status = document.getElementById("status");
    const grid = document.getElementById("grid");
    grid.innerHTML = "";

    // 1) å–å¾—æ‰€åœ¨åœ°ï¼ˆå½±éŸ¿åŠ æ¬Šï¼‰
    let locCity = document.getElementById("city").value;
    const useGeo = document.getElementById("useGeo").checked;

    if(useGeo && navigator.geolocation){
      try{
        const pos = await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej,{timeout:4000}));
        // é€™è£¡åƒ…åšç¤ºæ„ï¼šå¯¦å‹™ä¸Šå¯æŠŠç¶“ç·¯åº¦åæŸ¥ç¸£å¸‚
        // å…ˆä»¥ã€Œæœ€è¿‘ã€ä¾†åˆ¤æ–·æ˜¯å¦åŒç¸£å¸‚åŠ æ¬Š
        const my = {lat:pos.coords.latitude, lng:pos.coords.longitude};
        // ç²—ç•¥ï¼šè·é›¢æœ€è¿‘çš„ spot æ‰€åœ¨ç¸£å¸‚
        let minD = Infinity, nearCity = locCity;
        for(const sp of SPOTS){
          const d = Math.hypot(sp.lat-my.lat, sp.lng-my.lng);
          if(d<minD){minD=d;nearCity=sp.city;}
        }
        locCity = nearCity;
      }catch(e){/* ignore */ }
    }

    // 2) ä¾†æºè³‡æ–™
    const useApi = USE_OPENAPI;
    status.textContent = useApi ? "é€£ç·š" : "å¿«å–";

    // 3) çµ„æˆæ¸…å–®
    const list = [];
    for(const sp of SPOTS){
      // æ¨¡æ“¬æˆ–çœŸå¯¦å€¼ï¼ˆæ­¤ç‰ˆä»¥ mock ç‚ºä¸»ï¼‰
      const m = {...sp.mock}; // è‹¥æ¥ APIï¼Œåœ¨é€™è£¡è¦†è“‹ m.T/m.POP/m.UV/m.AQI

      // Base åˆ†æ•¸
      let score = calcTripScore(m);
      // æ‰€åœ¨åœ°åŠ æ¬Šï¼šåŒç¸£å¸‚ +5ï¼›ä¸åŒç¸£å¸‚ 0ï¼›é›¢å³¶å·®ç•° -5ï¼ˆç¤ºæ„ï¼‰
      const same = (sp.city.includes(locCity) || locCity.includes(sp.city));
      const isIsland = /æ¾æ¹–|é‡‘é–€|é¦¬ç¥–/.test(sp.city) && !/æ¾æ¹–|é‡‘é–€|é¦¬ç¥–/.test(locCity);
      if(same) score += 5;
      if(isIsland) score -= 5;
      score = Math.max(0,Math.min(100,score));

      list.push({
        ...sp,
        T:m.T, POP:m.POP, UV:m.UV, AQI:m.AQI,
        score
      });
    }

    // æ’åºï¼šé«˜åˆ†åœ¨å‰
    list.sort((a,b)=>b.score-a.score);

    // æ›´æ–°æ™‚é–“
    const now = new Date();
    document.getElementById("lastUpdate").textContent =
      "æ›´æ–°æ™‚é–“ï¼š" + now.toLocaleString("zh-TW", {hour12:false});

    // å¡å¡ç‰‡
    const frag = document.createDocumentFragment();
    list.forEach(sp=>frag.appendChild(createCard(sp)));
    grid.appendChild(frag);
  }

  // init
  document.getElementById("btnReload").addEventListener("click", loadData);
  document.getElementById("city").addEventListener("change", loadData);
  document.getElementById("useGeo").addEventListener("change", loadData);
  loadData();
  </script>
</body>
</html>
